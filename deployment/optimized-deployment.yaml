# HuanuCanvas优化部署配置
# 基于project-deploy skill的完整配置

# ========================================
# 项目基本信息
# ========================================
project:
  name: "HuanuCanvas"
  display_name: "penguin-magic"
  version: "1.4.1"
  description: "React 19 + Vite + Node.js + Electron全栈AI图像创意管理应用"
  repository: "https://github.com/tcJackClay/HuanuCanvas"
  documentation: "https://github.com/tcJackClay/HuanuCanvas/blob/main/README.md"

# ========================================
# 部署配置
# ========================================
deployment:
  # 目标平台: self-hosted, aliyun, docker
  target: "self-hosted"
  
  # 环境: development, staging, production
  environment: "${DEPLOYMENT_ENV:-production}"
  
  # 部署策略: blue-green, rolling, recreate
  strategy: "${DEPLOYMENT_STRATEGY:-blue-green}"
  
  # 回滚配置
  rollback:
    enabled: true
    automatic: true
    timeout: 300
    backup_retention: 7
  
  # 健康检查配置
  health_check:
    enabled: true
    timeout: 300
    interval: 30
    retries: 3
    endpoints:
      - path: "/health"
        port: 80
        method: "GET"
      - path: "/api/health"
        port: 8765
        method: "GET"

# ========================================
# 服务器配置
# ========================================
servers:
  production:
    hostname: "192.168.10.5"
    user: "root"
    port: 22
    environment: "production"
    resources:
      cpu: "2"
      memory: "4Gi"
      disk: "50Gi"
    services:
      - frontend
      - backend
      - database
      - redis
      - monitoring

  staging:
    hostname: "192.168.10.6"
    user: "root"
    port: 22
    environment: "staging"
    resources:
      cpu: "1"
      memory: "2Gi"
      disk: "20Gi"
    services:
      - frontend
      - backend
      - database
      - monitoring

# ========================================
# Docker配置
# ========================================
docker:
  registry:
    type: "ghcr.io"  # github container registry
    namespace: "tcJackClay"
    repository: "huanu-canvas"
  
  compose:
    version: "3.8"
    file: "deployment/docker-compose.yml"
    env_file: "deployment/.env.${environment}"
  
  images:
    frontend:
      name: "huanu-canvas-frontend"
      build:
        context: "."
        dockerfile: "deployment/Dockerfile.frontend"
        args:
          NODE_ENV: "${NODE_ENV:-production}"
          BUILD_VERSION: "${BUILD_VERSION:-latest}"
      ports:
        - "80:80"
        - "443:443"
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 128M
    
    backend:
      name: "huanu-canvas-backend"
      build:
        context: "."
        dockerfile: "deployment/Dockerfile.backend"
        args:
          NODE_ENV: "${NODE_ENV:-production}"
          BUILD_VERSION: "${BUILD_VERSION:-latest}"
      ports:
        - "8765:8765"
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.2'
          memory: 256M
    
    database:
      name: "postgres"
      image: "postgres:15-alpine"
      environment:
        POSTGRES_DB: "${POSTGRES_DB:-huanu}"
        POSTGRES_USER: "${POSTGRES_USER:-huanu}"
        POSTGRES_PASSWORD: "${POSTGRES_PASSWORD}"
      volumes:
        - "postgres_data:/var/lib/postgresql/data"
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
    
    redis:
      name: "redis"
      image: "redis:7-alpine"
      command: "redis-server --appendonly yes"
      volumes:
        - "redis_data:/data"
      resources:
        limits:
          cpus: '0.25'
          memory: 256M

# ========================================
# 监控配置
# ========================================
monitoring:
  enabled: true
  
  # Prometheus配置
  prometheus:
    enabled: true
    port: 9090
    retention: "30d"
    scrape_interval: "15s"
    evaluation_interval: "15s"
    rules:
      - file: "deployment/monitoring/rules/*.yml"
  
  # Grafana配置
  grafana:
    enabled: true
    port: 3000
    admin_user: "admin"
    admin_password: "${GRAFANA_PASSWORD}"
    dashboards:
      - name: "HuanuCanvas Overview"
        file: "deployment/monitoring/grafana/dashboards/huanu-overview.json"
    datasources:
      - name: "Prometheus"
        type: "prometheus"
        url: "http://prometheus:9090"
  
  # 日志聚合
  logging:
    enabled: true
    type: "loki"
    port: 3100
    retention: "7d"
    config: "deployment/monitoring/loki/loki-config.yml"
  
  # 告警配置
  alerting:
    enabled: true
    manager: "alertmanager"
    port: 9093
    rules:
      - file: "deployment/monitoring/alert-rules.yml"
      - service: "frontend"
        threshold:
          response_time: "2s"
          error_rate: "5%"
          availability: "99%"
      - service: "backend"
        threshold:
          response_time: "1s"
          error_rate: "2%"
          availability: "99.5%"
      - service: "database"
        threshold:
          connection_count: "80"
          disk_usage: "85%"
          memory_usage: "80%"
    
    # 通知渠道
    notifications:
      slack:
        enabled: "${SLACK_NOTIFICATIONS_ENABLED:-false}"
        webhook_url: "${SLACK_WEBHOOK}"
        channel: "#alerts"
        username: "HuanuCanvas-Alerts"
      
      email:
        enabled: "${EMAIL_NOTIFICATIONS_ENABLED:-false}"
        smtp_server: "${SMTP_SERVER}"
        smtp_port: "${SMTP_PORT}"
        username: "${SMTP_USERNAME}"
        password: "${SMTP_PASSWORD}"
        to_addresses: "${ALERT_EMAIL_RECIPIENTS}"

# ========================================
# 安全配置
# ========================================
security:
  # 网络安全
  network:
    firewall:
      enabled: true
      rules:
        - "allow ssh from 192.168.0.0/16"
        - "allow http from any"
        - "allow https from any"
        - "allow monitoring from 192.168.0.0/16"
    
    ssl:
      enabled: true
      provider: "letsencrypt"
      domains: "${SSL_DOMAINS}"
      email: "${SSL_EMAIL}"
      auto_renewal: true
  
  # 容器安全
  container:
    user: "non-root"
    read_only: true
    capabilities:
      drop: ["ALL"]
      add: ["NET_BIND_SERVICE"]
    security_opts:
      - "no-new-privileges:true"
    secrets:
      management: "vault"
      rotation: "30d"
  
  # 应用安全
  application:
    authentication:
      type: "jwt"
      secret_rotation: "90d"
      session_timeout: "24h"
    
    authorization:
      rbac: true
      default_role: "user"
    
    rate_limiting:
      enabled: true
      window: "15m"
      max_requests: "100"
    
    cors:
      enabled: true
      origins: "${ALLOWED_ORIGINS}"
      methods: ["GET", "POST", "PUT", "DELETE"]
      credentials: true
    
    headers:
      hsts: true
      x_frame_options: "DENY"
      x_content_type_options: "nosniff"
      content_security_policy: "default-src 'self'"

# ========================================
# 备份配置
# ========================================
backup:
  enabled: true
  
  # 策略配置
  strategy:
    database:
      type: "automated"
      schedule: "0 2 * * *"  # 每天凌晨2点
      retention: "30d"
      compression: true
      encryption: true
    
    files:
      type: "automated"
      schedule: "0 3 * * *"  # 每天凌晨3点
      retention: "7d"
      paths:
        - "/opt/huanu-canvas/app/data"
        - "/opt/huanu-canvas/config"
        - "/opt/huanu-canvas/deployment"
    
    full_system:
      type: "scheduled"
      schedule: "0 1 * * 0"  # 每周日凌晨1点
      retention: "12w"
  
  # 存储配置
  storage:
    local:
      enabled: true
      path: "/opt/backups"
      max_size: "100Gi"
    
    remote:
      enabled: "${REMOTE_BACKUP_ENABLED:-false}"
      type: "s3"  # s3, ftp, sftp
      bucket: "${S3_BACKUP_BUCKET}"
      region: "${S3_BACKUP_REGION}"
      access_key: "${S3_ACCESS_KEY}"
      secret_key: "${S3_SECRET_KEY}"
  
  # 恢复配置
  recovery:
    test_schedule: "0 4 * * 1"  # 每周一凌晨4点测试恢复
    notification: true
    rollback_on_failure: true

# ========================================
# CI/CD配置
# ========================================
cicd:
  # GitHub Actions
  github:
    enabled: true
    workflows:
      - "ci-cd.yml"
      - "deploy.yml"
    environments:
      - "staging"
      - "production"
    secrets:
      management: "github-secrets"
    
    # 流水线配置
    pipeline:
      stages:
        - name: "Quality Checks"
          timeout: "15m"
          steps:
            - "code-quality"
            - "security-scan"
            - "dependency-check"
        
        - name: "Testing"
          timeout: "20m"
          steps:
            - "unit-tests"
            - "integration-tests"
            - "e2e-tests"
        
        - name: "Build"
          timeout: "30m"
          steps:
            - "docker-build"
            - "security-scan"
            - "push-images"
        
        - name: "Deploy"
          timeout: "45m"
          steps:
            - "deploy-staging"
            - "integration-tests"
            - "deploy-production"
  
  # 自动化规则
  automation:
    auto_deploy:
      enabled: true
      branches: ["main", "develop"]
      conditions:
        - "all_checks_passed"
        - "no_security_issues"
        - "approval_received"
    
    version_management:
      enabled: true
      strategy: "semantic"
      auto_bump: true
    
    notification:
      slack: true
      email: true
      success_threshold: "all_tests_pass"
      failure_threshold: "any_test_failed"

# ========================================
# 性能配置
# ========================================
performance:
  # 应用优化
  application:
    frontend:
      optimization:
        - "code-splitting"
        - "tree-shaking"
        - "asset-compression"
        - "cdn-integration"
      cache:
        strategy: "aggressive"
        ttl: "24h"
        compression: "gzip"
    
    backend:
      optimization:
        - "connection-pooling"
        - "query-optimization"
        - "caching-strategy"
      workers: "auto"
      max_connections: "100"
  
  # 基础设施优化
  infrastructure:
    load_balancing:
      enabled: true
      algorithm: "round-robin"
      health_check: true
    
    auto_scaling:
      enabled: true
      metrics:
        - "cpu_utilization"
        - "memory_utilization"
        - "request_rate"
      scale_up_threshold: "70%"
      scale_down_threshold: "30%"
      cooldown_period: "300s"
    
    caching:
      redis:
        enabled: true
        max_memory: "512mb"
        eviction_policy: "allkeys-lru"
      application:
        enabled: true
        ttl: "3600"  # 1 hour

# ========================================
# 环境变量
# ========================================
environment:
  # 基础配置
  NODE_ENV: "${NODE_ENV:-production}"
  APP_NAME: "HuanuCanvas"
  APP_VERSION: "${APP_VERSION:-1.4.1}"
  
  # 服务器配置
  SERVER_IP: "${SERVER_IP:-192.168.10.5}"
  DOMAIN: "${DOMAIN:-localhost}"
  
  # 端口配置
  FRONTEND_PORT: "${FRONTEND_PORT:-80}"
  BACKEND_PORT: "${BACKEND_PORT:-8765}"
  DATABASE_PORT: "${DATABASE_PORT:-5432}"
  REDIS_PORT: "${REDIS_PORT:-6379}"
  
  # API密钥
  GEMINI_API_KEY: "${GEMINI_API_KEY}"
  JWT_SECRET: "${JWT_SECRET}"
  SESSION_SECRET: "${SESSION_SECRET}"
  
  # 数据库配置
  POSTGRES_DB: "${POSTGRES_DB:-huanu}"
  POSTGRES_USER: "${POSTGRES_USER:-huanu}"
  POSTGRES_PASSWORD: "${POSTGRES_PASSWORD}"
  DATABASE_URL: "postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}"
  
  # Redis配置
  REDIS_URL: "redis://redis:6379"
  
  # 监控配置
  GRAFANA_PASSWORD: "${GRAFANA_PASSWORD}"
  PROMETHEUS_PORT: "${PROMETHEUS_PORT:-9090}"
  
  # 存储路径
  DATA_PATH: "${DATA_PATH:-/opt/huanu-canvas/app/data}"
  INPUT_PATH: "${INPUT_PATH:-/opt/huanu-canvas/app/input}"
  OUTPUT_PATH: "${OUTPUT_PATH:-/opt/huanu-canvas/app/output}"
  CREATIVE_IMAGES_PATH: "${CREATIVE_IMAGES_PATH:-/opt/huanu-canvas/app/creative_images}"
  THUMBNAILS_PATH: "${THUMBNAILS_PATH:-/opt/huanu-canvas/app/thumbnails}"
  
  # 安全配置
  ALLOWED_ORIGINS: "${ALLOWED_ORIGINS:-http://localhost}"
  SESSION_TIMEOUT: "${SESSION_TIMEOUT:-24h}"
  RATE_LIMIT_WINDOW: "${RATE_LIMIT_WINDOW:-900000}"
  RATE_LIMIT_MAX: "${RATE_LIMIT_MAX:-100}"
  
  # 性能配置
  MAX_CONCURRENT_REQUESTS: "${MAX_CONCURRENT_REQUESTS:-10}"
  WORKER_THREADS: "${WORKER_THREADS:-auto}"
  
  # 通知配置
  SLACK_WEBHOOK: "${SLACK_WEBHOOK}"
  EMAIL_NOTIFICATION: "${EMAIL_NOTIFICATION}"

# ========================================
# 自定义脚本
# ========================================
scripts:
  # 部署脚本
  deploy:
    - "deployment/scripts/intelligent-deploy.sh"
    - "deployment/scripts/github-automation.sh"
  
  # 健康检查
  health_check:
    - "deployment/scripts/health-check.sh"
  
  # 备份脚本
  backup:
    - "deployment/scripts/backup.sh"
    - "deployment/scripts/restore.sh"
  
  # 维护脚本
  maintenance:
    - "deployment/scripts/maintenance.sh"
    - "deployment/scripts/cleanup.sh"
  
  # 监控脚本
  monitoring:
    - "deployment/scripts/monitoring-setup.sh"
    - "deployment/scripts/alert-test.sh"

# ========================================
# 文档和帮助
# ========================================
documentation:
  deployment:
    guide: "deployment/README.md"
    troubleshooting: "deployment/TROUBLESHOOTING.md"
    monitoring: "deployment/MONITORING.md"
  
  api:
    docs: "docs/api.md"
    examples: "docs/examples/"
  
  development:
    setup: "docs/development/setup.md"
    contributing: "CONTRIBUTING.md"

# ========================================
# 扩展配置
# ========================================
extensions:
  # 功能扩展
  features:
    ai_integration:
      enabled: true
      provider: "google-gemini"
      api_key_required: true
    
    electron_app:
      enabled: true
      platforms: ["linux", "win32", "darwin"]
      auto_update: true
    
    collaboration:
      enabled: false
      provider: "socket.io"
    
    analytics:
      enabled: true
      provider: "custom"
      tracking: true
  
  # 第三方集成
  integrations:
    github:
      enabled: true
      webhook: true
      releases: true
    
    docker_hub:
      enabled: false
      registry: "ghcr.io"
    
    cloud_storage:
      enabled: false
      provider: "aws-s3"
      backup: true
  
  # 实验性功能
  experimental:
    wasm_support: false
    pwa: true
    service_worker: true
    offline_support: false