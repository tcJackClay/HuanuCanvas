<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RunningHub åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header { text-align: center; margin-bottom: 30px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 4px; }
        .test-result { margin: 10px 0; font-family: monospace; background: #f8f9fa; padding: 10px; border-radius: 4px; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        .json-display { background: #f8f9fa; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 12px; overflow-x: auto; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ‰ RunningHub åŠŸèƒ½æµ‹è¯•</h1>
            <p>éªŒè¯ä¿®å¤åçš„RunningHubåŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œ</p>
        </div>

        <div class="test-section">
            <h2>ğŸ“¡ APIè¿æ¥æµ‹è¯•</h2>
            <button onclick="testAPIs()">æµ‹è¯•æ‰€æœ‰API</button>
            <div id="api-results"></div>
        </div>

        <div class="test-section">
            <h2>ğŸ” èŠ‚ç‚¹ä¿¡æ¯æµ‹è¯•</h2>
            <button onclick="testNodeInfo()">æµ‹è¯•èŠ‚ç‚¹ä¿¡æ¯</button>
            <div id="node-results"></div>
        </div>

        <div class="test-section">
            <h2>ğŸ¯ å®Œæ•´æµç¨‹æµ‹è¯•</h2>
            <button onclick="testFullFlow()">æµ‹è¯•å®Œæ•´æµç¨‹</button>
            <div id="flow-results"></div>
        </div>

        <div class="test-section">
            <h2>ğŸ“Š æµ‹è¯•ç»“æœæ€»ç»“</h2>
            <div id="summary"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5206/api/runninghub';
        let testResults = [];

        function log(message, type = 'info') {
            console.log(`[${type.toUpperCase()}] ${message}`);
            return { message, type, timestamp: new Date().toISOString() };
        }

        async function testAPIs() {
            const resultsDiv = document.getElementById('api-results');
            resultsDiv.innerHTML = '<div class="status info">æ­£åœ¨æµ‹è¯•APIè¿æ¥...</div>';

            const results = [];

            try {
                // æµ‹è¯•åŠŸèƒ½åˆ—è¡¨API
                const functionsResponse = await fetch(`${API_BASE}/functions`);
                const functionsData = await functionsResponse.json();
                results.push(log(`åŠŸèƒ½åˆ—è¡¨API: ${functionsData.success ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥'} - æ‰¾åˆ° ${functionsData.count} ä¸ªåŠŸèƒ½`));
                
                if (functionsData.success) {
                    resultsDiv.innerHTML = `
                        <div class="status success">âœ… åŠŸèƒ½åˆ—è¡¨APIæµ‹è¯•æˆåŠŸ</div>
                        <div class="test-result">æ‰¾åˆ° ${functionsData.count} ä¸ªRunningHubåŠŸèƒ½:</div>
                        <div class="json-display">${JSON.stringify(functionsData.data.map(f => ({
                            id: f.id,
                            name: f.name,
                            category: f.category
                        })), null, 2)}</div>
                    `;
                } else {
                    resultsDiv.innerHTML = `<div class="status error">âŒ åŠŸèƒ½åˆ—è¡¨APIæµ‹è¯•å¤±è´¥</div>`;
                }

                // æµ‹è¯•é…ç½®API
                const configResponse = await fetch(`${API_BASE}/config`);
                const configData = await configResponse.json();
                results.push(log(`é…ç½®API: ${configData.configured ? 'âœ… å·²é…ç½®' : 'âŒ æœªé…ç½®'}`));
                
            } catch (error) {
                results.push(log(`APIæµ‹è¯•å¤±è´¥: ${error.message}`, 'error'));
                resultsDiv.innerHTML = `<div class="status error">âŒ APIæµ‹è¯•å¤±è´¥: ${error.message}</div>`;
            }

            testResults.push(...results);
            updateSummary();
        }

        async function testNodeInfo() {
            const resultsDiv = document.getElementById('node-results');
            resultsDiv.innerHTML = '<div class="status info">æ­£åœ¨æµ‹è¯•èŠ‚ç‚¹ä¿¡æ¯è·å–...</div>';

            const results = [];

            try {
                // ä½¿ç”¨å›¾ç‰‡æ”¾å¤§åŠŸèƒ½çš„webappIdè¿›è¡Œæµ‹è¯•
                const response = await fetch(`${API_BASE}/node-info`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ webappId: '2007596875607707650' })
                });

                const data = await response.json();
                
                if (data.success && data.hasNodes) {
                    results.push(log(`èŠ‚ç‚¹ä¿¡æ¯è·å–: âœ… æˆåŠŸ - æ‰¾åˆ° ${data.nodeCount} ä¸ªèŠ‚ç‚¹`));
                    
                    resultsDiv.innerHTML = `
                        <div class="status success">âœ… èŠ‚ç‚¹ä¿¡æ¯è·å–æµ‹è¯•æˆåŠŸ</div>
                        <div class="test-result">
                            <strong>åº”ç”¨åç§°:</strong> ${data.data.data.webappName}<br>
                            <strong>èŠ‚ç‚¹æ•°é‡:</strong> ${data.nodeCount}<br>
                            <strong>å°é¢æ•°é‡:</strong> ${data.data.data.covers?.length || 0}
                        </div>
                        <div class="json-display">
                            <strong>èŠ‚ç‚¹ä¿¡æ¯:</strong><br>
                            ${JSON.stringify(data.data.data.nodeInfoList.map(n => ({
                                nodeId: n.nodeId,
                                nodeName: n.nodeName,
                                fieldType: n.fieldType,
                                fieldName: n.fieldName
                            })), null, 2)}
                        </div>
                    `;
                } else {
                    results.push(log(`èŠ‚ç‚¹ä¿¡æ¯è·å–: âŒ å¤±è´¥`, 'error'));
                    resultsDiv.innerHTML = `<div class="status error">âŒ èŠ‚ç‚¹ä¿¡æ¯è·å–æµ‹è¯•å¤±è´¥</div>`;
                }

            } catch (error) {
                results.push(log(`èŠ‚ç‚¹ä¿¡æ¯æµ‹è¯•å¤±è´¥: ${error.message}`, 'error'));
                resultsDiv.innerHTML = `<div class="status error">âŒ èŠ‚ç‚¹ä¿¡æ¯æµ‹è¯•å¤±è´¥: ${error.message}</div>`;
            }

            testResults.push(...results);
            updateSummary();
        }

        async function testFullFlow() {
            const resultsDiv = document.getElementById('flow-results');
            resultsDiv.innerHTML = '<div class="status info">æ­£åœ¨æµ‹è¯•å®Œæ•´æµç¨‹...</div>';

            const results = [];

            try {
                // æ¨¡æ‹Ÿå®Œæ•´çš„å‰ç«¯æµç¨‹
                results.push(log('å¼€å§‹å®Œæ•´æµç¨‹æµ‹è¯•...'));
                
                // 1. è·å–åŠŸèƒ½åˆ—è¡¨
                const functionsResponse = await fetch(`${API_BASE}/functions`);
                const functionsData = await functionsResponse.json();
                
                if (!functionsData.success) {
                    throw new Error('æ— æ³•è·å–åŠŸèƒ½åˆ—è¡¨');
                }
                
                results.push(log(`âœ… æ­¥éª¤1: è·å–åŠŸèƒ½åˆ—è¡¨ - ${functionsData.count} ä¸ªåŠŸèƒ½`));

                // 2. é€‰æ‹©ç¬¬ä¸€ä¸ªåŠŸèƒ½å¹¶è·å–èŠ‚ç‚¹ä¿¡æ¯
                const firstFunction = functionsData.data[0];
                const nodeInfoResponse = await fetch(`${API_BASE}/node-info`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ webappId: firstFunction.webappId })
                });

                const nodeInfoData = await nodeInfoResponse.json();
                
                if (!nodeInfoData.success) {
                    throw new Error('æ— æ³•è·å–èŠ‚ç‚¹ä¿¡æ¯');
                }

                results.push(log(`âœ… æ­¥éª¤2: è·å–èŠ‚ç‚¹ä¿¡æ¯ - ${nodeInfoData.nodeCount} ä¸ªèŠ‚ç‚¹`));

                // 3. éªŒè¯æ•°æ®ç»“æ„
                const hasConfigurableNodes = nodeInfoData.data.data.nodeInfoList.some(n => 
                    n.fieldType === 'STRING' || n.fieldType === 'LIST'
                );
                
                const hasImageNodes = nodeInfoData.data.data.nodeInfoList.some(n => 
                    n.fieldType === 'IMAGE'
                );

                results.push(log(`âœ… æ­¥éª¤3: éªŒè¯é…ç½®é€‰é¡¹ - å¯é…ç½®: ${hasConfigurableNodes ? 'æ˜¯' : 'å¦'}, æ–‡ä»¶ä¸Šä¼ : ${hasImageNodes ? 'æ˜¯' : 'å¦'}`));

                // 4. éªŒè¯ç•Œé¢æ¸²æŸ“æ•°æ®
                if (hasConfigurableNodes || hasImageNodes) {
                    results.push(log(`âœ… æ­¥éª¤4: ç•Œé¢æ¸²æŸ“æ•°æ®å®Œæ•´ - å‰ç«¯åº”è¯¥èƒ½æ­£å¸¸æ˜¾ç¤ºé…ç½®é€‰é¡¹`));
                    
                    resultsDiv.innerHTML = `
                        <div class="status success">âœ… å®Œæ•´æµç¨‹æµ‹è¯•æˆåŠŸ</div>
                        <div class="test-result">
                            <strong>æµ‹è¯•æµç¨‹:</strong><br>
                            âœ… 1. è·å–åŠŸèƒ½åˆ—è¡¨ - æˆåŠŸ<br>
                            âœ… 2. è·å–èŠ‚ç‚¹ä¿¡æ¯ - æˆåŠŸ<br>
                            âœ… 3. éªŒè¯é…ç½®é€‰é¡¹ - æˆåŠŸ<br>
                            âœ… 4. éªŒè¯ç•Œé¢æ¸²æŸ“ - æˆåŠŸ<br><br>
                            <strong>ç»“è®º:</strong> æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼Œå‰ç«¯åº”è¯¥èƒ½å¤Ÿæ­£å¸¸æ˜¾ç¤ºé…ç½®é€‰é¡¹ï¼Œä¸å†æ˜¾ç¤º"æš‚æ— é…ç½®é€‰é¡¹"
                        </div>
                    `;
                } else {
                    results.push(log('âš ï¸ æ­¥éª¤4: æ²¡æœ‰æ‰¾åˆ°é…ç½®é€‰é¡¹', 'warning'));
                    resultsDiv.innerHTML = `<div class="status info">âš ï¸ å®Œæ•´æµç¨‹æµ‹è¯•å®Œæˆï¼Œä½†æ²¡æœ‰æ‰¾åˆ°å¯é…ç½®é€‰é¡¹</div>`;
                }

            } catch (error) {
                results.push(log(`å®Œæ•´æµç¨‹æµ‹è¯•å¤±è´¥: ${error.message}`, 'error'));
                resultsDiv.innerHTML = `<div class="status error">âŒ å®Œæ•´æµç¨‹æµ‹è¯•å¤±è´¥: ${error.message}</div>`;
            }

            testResults.push(...results);
            updateSummary();
        }

        function updateSummary() {
            const summaryDiv = document.getElementById('summary');
            const totalTests = testResults.length;
            const successTests = testResults.filter(r => !r.message.includes('âŒ')).length;
            const successRate = Math.round((successTests / totalTests) * 100);

            const summary = `
                <div class="test-result">
                    <strong>æµ‹è¯•ç»Ÿè®¡:</strong><br>
                    æ€»æµ‹è¯•æ•°: ${totalTests}<br>
                    æˆåŠŸæµ‹è¯•: ${successTests}<br>
                    æˆåŠŸç‡: ${successRate}%<br><br>
                    <strong>ä¿®å¤éªŒè¯:</strong><br>
                    ${successRate >= 80 ? 
                        'ğŸ‰ <span style="color: green; font-weight: bold;">ä¿®å¤æˆåŠŸï¼</span> - å‰ç«¯åº”è¯¥èƒ½æ­£å¸¸æ˜¾ç¤ºé…ç½®é€‰é¡¹' : 
                        'âš ï¸ <span style="color: orange; font-weight: bold;">éœ€è¦è¿›ä¸€æ­¥è°ƒè¯•</span>'
                    }
                </div>
            `;

            summaryDiv.innerHTML = summary;
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡ŒåŸºæœ¬æµ‹è¯•
        window.onload = function() {
            setTimeout(() => {
                testAPIs();
            }, 1000);
        };
    </script>
</body>
</html>