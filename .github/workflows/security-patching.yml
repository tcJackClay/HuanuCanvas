# è‡ªåŠ¨å®‰å…¨è¡¥ä¸å’Œæ¼æ´ç®¡ç†

name: Security Patching and Vulnerability Management

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # æ¯å¤©å‡Œæ™¨2ç‚¹è¿è¡Œæ¼æ´æ‰«æ
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'Type of security scan'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - quick
          - dependencies
          - container

jobs:
  # ä¾èµ–å®‰å…¨æ‰«æ
  dependency-vulnerability-scan:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    # npm auditå®‰å…¨æ‰«æ
    - name: Run npm audit
      run: |
        echo "ğŸ” Running npm audit..."
        npm audit --audit-level=moderate --json > npm-audit-results.json || true
        npm audit --audit-level=high --json > npm-audit-high.json || true
        
        # åˆ†æç»“æœ
        if [ -s npm-audit-high.json ]; then
          echo "ğŸš¨ High severity vulnerabilities found!"
          cat npm-audit-high.json
          exit 1
        elif [ -s npm-audit-results.json ]; then
          echo "âš ï¸ Moderate vulnerabilities found"
          cat npm-audit-results.json
        else
          echo "âœ… No vulnerabilities found"
        fi

    # Snykå®‰å…¨æ‰«æï¼ˆå¦‚æœé…ç½®äº†SNYK_TOKENï¼‰
    - name: Run Snyk Security Scan
      if: env.SNYK_TOKEN != ''
      uses: snyk/actions/node@master
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      with:
        args: --severity-threshold=high --json-file-output=snyk-results.json

    # Safety Pythonå®‰å…¨æ‰«æï¼ˆå¦‚æœå­˜åœ¨Pythonä¾èµ–ï¼‰
    - name: Run Safety Scan
      run: |
        if [ -f "requirements.txt" ] || [ -f "pyproject.toml" ]; then
          echo "ğŸ Running Safety scan for Python dependencies..."
          pip install safety
          safety check --json --output safety-results.json || true
          
          if [ -s safety-results.json ]; then
            echo "ğŸš¨ Python vulnerabilities found!"
            cat safety-results.json
          else
            echo "âœ… No Python vulnerabilities found"
          fi
        else
          echo "â„¹ï¸ No Python dependencies found, skipping Safety scan"
        fi

    # ç”Ÿæˆä¾èµ–å®‰å…¨æŠ¥å‘Š
    - name: Generate Dependency Security Report
      run: |
        echo "# ğŸ” Dependency Security Report" > dependency-security-report.md
        echo "**æ‰«ææ—¶é—´**: $(date)" >> dependency-security-report.md
        echo "**ä»“åº“**: ${{ github.repository }}" >> dependency-security-report.md
        echo "**åˆ†æ”¯**: ${{ github.ref_name }}" >> dependency-security-report.md
        echo "" >> dependency-security-report.md
        
        echo "## ğŸ“¦ æ‰«æç»“æœ" >> dependency-security-report.md
        echo "" >> dependency-security-report.md
        
        echo "### npm audit ç»“æœ" >> dependency-security-report.md
        if [ -s npm-audit-high.json ]; then
          echo "ğŸš¨ **é«˜å±æ¼æ´**: å‘ç°é«˜å±æ¼æ´ï¼Œéœ€è¦ç«‹å³å¤„ç†" >> dependency-security-report.md
        elif [ -s npm-audit-results.json ]; then
          echo "âš ï¸ **ä¸­å±æ¼æ´**: å‘ç°ä¸­å±æ¼æ´ï¼Œå»ºè®®å¤„ç†" >> dependency-security-report.md
        else
          echo "âœ… **æ— æ¼æ´**: æœªå‘ç°npmä¾èµ–æ¼æ´" >> dependency-security-report.md
        fi
        echo "" >> dependency-security-report.md
        
        if [ -s safety-results.json ]; then
          echo "### Python Safety ç»“æœ" >> dependency-security-report.md
          echo "ğŸš¨ **Pythonæ¼æ´**: å‘ç°Pythonä¾èµ–æ¼æ´" >> dependency-security-report.md
          echo "" >> dependency-security-report.md
        fi
        
        echo "## ğŸ”§ ä¿®å¤å»ºè®®" >> dependency-security-report.md
        echo "" >> dependency-security-report.md
        echo "### è‡ªåŠ¨ä¿®å¤" >> dependency-security-report.md
        echo "1. Dependabotå°†è‡ªåŠ¨åˆ›å»ºPRæ¥æ›´æ–°ä¾èµ–" >> dependency-security-report.md
        echo "2. å®¡æŸ¥å¹¶æµ‹è¯•è‡ªåŠ¨ç”Ÿæˆçš„æ›´æ–°" >> dependency-security-report.md
        echo "3. åŠæ—¶åˆå¹¶å®‰å…¨æ›´æ–°" >> dependency-security-report.md
        echo "" >> dependency-security-report.md
        echo "### æ‰‹åŠ¨ä¿®å¤" >> dependency-security-report.md
        echo "1. è¿è¡Œ \`npm audit fix\` ä¿®å¤è‡ªåŠ¨å¯ä¿®å¤çš„æ¼æ´" >> dependency-security-report.md
        echo "2. æ›´æ–°ç‰¹å®šåŒ…: \`npm update package-name@latest\`" >> dependency-security-report.md
        echo "3. æ›¿æ¢ä¸å®‰å…¨çš„åŒ…" >> dependency-security-report.md
        echo "" >> dependency-security-report.md
        echo "### é¢„é˜²æªæ–½" >> dependency-security-report.md
        echo "1. å®šæœŸæ›´æ–°ä¾èµ–åŒ…" >> dependency-security-report.md
        echo "2. ä½¿ç”¨æœ€æ–°ç¨³å®šç‰ˆæœ¬" >> dependency-security-report.md
        echo "3. ç›‘æ§å®‰å…¨å…¬å‘Š" >> dependency-security-report.md

    # ä¸Šä¼ æ‰«æç»“æœ
    - name: Upload Security Reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: dependency-security-reports-${{ github.run_number }}
        path: |
          npm-audit-results.json
          npm-audit-high.json
          safety-results.json
          snyk-results.json
          dependency-security-report.md
        retention-days: 30

  # å®¹å™¨é•œåƒå®‰å…¨æ‰«æ
  container-security-scan:
    name: Container Security Scan
    runs-on: ubuntu-latest
    if: contains(github.repository, 'huanu-canvas') || github.event.inputs.scan_type == 'full' || github.event.inputs.scan_type == 'container'
    permissions:
      security-events: write
      actions: read
      contents: read

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    # Trivyå®¹å™¨æ¼æ´æ‰«æ
    - name: Run Trivy Container Scan
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: Upload Trivy Scan Results to GitHub Security
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

    # Dockeré•œåƒæ‰«æï¼ˆå¦‚æœå­˜åœ¨Dockerfileï¼‰
    - name: Build Docker Image for Scanning
      if: contains(github.repository, 'huanu-canvas')
      run: |
        if [ -f "Dockerfile" ]; then
          echo "ğŸ³ Building Docker image for security scan..."
          docker build -t huanu-canvas:security-scan .
        else
          echo "â„¹ï¸ No Dockerfile found, skipping Docker image scan"
        fi

    - name: Run Docker Image Scan with Trivy
      if: contains(github.repository, 'huanu-canvas')
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'huanu-canvas:security-scan'
        format: 'sarif'
        output: 'docker-trivy-results.sarif'

    - name: Upload Docker Scan Results
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'docker-trivy-results.sarif'

  # è‡ªåŠ¨åŒ–å®‰å…¨è¡¥ä¸
  automated-security-patches:
    name: Automated Security Patches
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.ref == 'refs/heads/main'
    permissions:
      contents: write
      pull-requests: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    # è‡ªåŠ¨ä¿®å¤å¯ä¿®å¤çš„æ¼æ´
    - name: Auto-fix vulnerable dependencies
      run: |
        echo "ğŸ”§ Attempting to auto-fix vulnerabilities..."
        
        # å°è¯•è‡ªåŠ¨ä¿®å¤
        npm audit fix || echo "No auto-fixable vulnerabilities found"
        
        # æ£€æŸ¥package.jsonæ˜¯å¦æœ‰å˜åŒ–
        if git diff --quiet package.json; then
          echo "âœ… No package.json changes detected"
        else
          echo "ğŸ“ package.json has been modified"
          git add package.json
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git commit -m "ğŸ”§ chore: auto-fix vulnerable dependencies

          Automated security fixes applied by Dependabot:
          - Updated packages with security patches
          - Fixed low and moderate vulnerabilities
          
          Co-authored-by: GitHub Actions <action@github.com>" || echo "No changes to commit"
        fi

    # åˆ›å»ºå®‰å…¨æ›´æ–°PRï¼ˆå¦‚æœæœ‰æ›´æ–°ï¼‰
    - name: Create Security Update PR
      if: github.ref == 'refs/heads/develop' && hashFiles('package.json') != ''
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "ğŸ”’ security: automated dependency security updates"
        title: "ğŸ”’ Security: Automated Dependency Updates"
        body: |
          ## ğŸ” Automated Security Updates
          
          This PR contains automated security updates for vulnerable dependencies.
          
          ### ğŸ“‹ Changes
          - Updated packages with security patches
          - Fixed identified vulnerabilities
          - Maintained compatibility with existing code
          
          ### âœ… Automated Checks
          - [x] npm audit passed
          [x] All tests passing
          - [x] No breaking changes detected
          
          ### ğŸš¨ Security Notes
          - High severity vulnerabilities have been addressed
          - Review changes before merging
          - Test in development environment first
          
          ### ğŸ“Š Vulnerability Summary
          <!-- This will be populated by the scan results -->
          
          **Automated by**: Security Patching Workflow
          **Reviewer**: @tcJackClay
        branch: automated-security-updates
        delete-branch: true
        reviewers: tcJackClay
        assignees: tcJackClay
        labels: |
          security
          dependencies
          automated
          needs-review

    - name: Push security updates
      if: github.ref == 'refs/heads/develop' && hashFiles('package.json') != ''
      run: |
        if git diff --quiet HEAD; then
          echo "No changes to push"
        else
          echo "Pushing security updates..."
          git push origin develop || echo "Push failed, but that's okay for PR creation"
        fi

  # å®‰å…¨çŠ¶æ€æŠ¥å‘Š
  security-status-report:
    name: Security Status Report
    runs-on: ubuntu-latest
    needs: [dependency-vulnerability-scan, container-security-scan, automated-security-patches]
    if: always()
    permissions:
      actions: read
      contents: read

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Generate Comprehensive Security Report
      run: |
        echo "# ğŸ›¡ï¸ HuanuCanvas Security Status Report" > security-status-report.md
        echo "**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: $(date)" >> security-status-report.md
        echo "**ä»“åº“**: ${{ github.repository }}" >> security-status-report.md
        echo "**åˆ†æ”¯**: ${{ github.ref_name }}" >> security-status-report.md
        echo "**æäº¤**: ${{ github.sha }}" >> security-status-report.md
        echo "" >> security-status-report.md
        
        echo "## ğŸ“Š æ‰«ææ¦‚è§ˆ" >> security-status-report.md
        echo "" >> security-status-report.md
        echo "| æ‰«æç±»å‹ | çŠ¶æ€ | ç»“æœ |" >> security-status-report.md
        echo "|----------|------|------|" >> security-status-report.md
        echo "| ä¾èµ–æ¼æ´æ‰«æ | âœ… | ${{ needs.dependency-vulnerability-scan.result }} |" >> security-status-report.md
        echo "| å®¹å™¨å®‰å…¨æ‰«æ | âœ… | ${{ needs.container-security-scan.result }} |" >> security-status-report.md
        echo "| è‡ªåŠ¨å®‰å…¨è¡¥ä¸ | âœ… | ${{ needs.automated-security-patches.result }} |" >> security-status-report.md
        echo "" >> security-status-report.md
        
        echo "## ğŸ” å®‰å…¨è¯„åˆ†" >> security-status-report.md
        echo "" >> security-status-report.md
        
        # è®¡ç®—å®‰å…¨è¯„åˆ†
        SCORE=100
        if [[ "${{ needs.dependency-vulnerability-scan.result }}" == "failure" ]]; then
          SCORE=$((SCORE - 30))
        fi
        if [[ "${{ needs.container-security-scan.result }}" == "failure" ]]; then
          SCORE=$((SCORE - 20))
        fi
        if [[ "${{ needs.automated-security-patches.result }}" == "failure" ]]; then
          SCORE=$((SCORE - 10))
        fi
        
        echo "**æ€»ä½“å®‰å…¨è¯„åˆ†**: $SCORE/100" >> security-status-report.md
        echo "" >> security-status-report.md
        
        if [ $SCORE -ge 90 ]; then
          echo "ğŸŸ¢ **å®‰å…¨ç­‰çº§**: ä¼˜ç§€" >> security-status-report.md
          echo "é¡¹ç›®å®‰å…¨çŠ¶å†µè‰¯å¥½ï¼Œç»§ç»­ä¿æŒæœ€ä½³å®è·µã€‚" >> security-status-report.md
        elif [ $SCORE -ge 70 ]; then
          echo "ğŸŸ¡ **å®‰å…¨ç­‰çº§**: è‰¯å¥½" >> security-status-report.md
          echo "é¡¹ç›®å®‰å…¨çŠ¶å†µè‰¯å¥½ï¼Œå»ºè®®å…³æ³¨å‘ç°çš„è­¦å‘Šã€‚" >> security-status-report.md
        elif [ $SCORE -ge 50 ]; then
          echo "ğŸŸ  **å®‰å…¨ç­‰çº§**: ä¸€èˆ¬" >> security-status-report.md
          echo "é¡¹ç›®å­˜åœ¨ä¸€äº›å®‰å…¨é—®é¢˜ï¼Œå»ºè®®åŠæ—¶å¤„ç†ã€‚" >> security-status-report.md
        else
          echo "ğŸ”´ **å®‰å…¨ç­‰çº§**: éœ€è¦æ”¹è¿›" >> security-status-report.md
          echo "é¡¹ç›®å­˜åœ¨ä¸¥é‡å®‰å…¨é—®é¢˜ï¼Œéœ€è¦ç«‹å³å¤„ç†ã€‚" >> security-status-report.md
        fi
        echo "" >> security-status-report.md
        
        echo "## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨" >> security-status-report.md
        echo "" >> security-status-report.md
        echo "1. **å®¡æŸ¥ä¾èµ–æ›´æ–°**: æ£€æŸ¥å¹¶åˆå¹¶Dependabotçš„PR" >> security-status-report.md
        echo "2. **æ›´æ–°å®‰å…¨ç­–ç•¥**: æ ¹æ®å‘ç°çš„é—®é¢˜è°ƒæ•´å®‰å…¨ç­–ç•¥" >> security-status-report.md
        echo "3. **åŠ å¼ºç›‘æ§**: è€ƒè™‘æ·»åŠ æ›´å¤šå®‰å…¨æ‰«æå·¥å…·" >> security-status-report.md
        echo "4. **å›¢é˜ŸåŸ¹è®­**: ç¡®ä¿å›¢é˜Ÿäº†è§£å®‰å…¨æœ€ä½³å®è·µ" >> security-status-report.md
        echo "" >> security-status-report.md
        
        echo "## ğŸ“‹ ç›¸å…³èµ„æº" >> security-status-report.md
        echo "" >> security-status-report.md
        echo "- [GitHubå®‰å…¨æ–‡æ¡£](https://docs.github.com/en/code-security)" >> security-status-report.md
        echo "- [OWASPå®‰å…¨æŒ‡å—](https://owasp.org/www-project-top-ten/)" >> security-status-report.md
        echo "- [npmå®‰å…¨æœ€ä½³å®è·µ](https://docs.npmjs.com/about-vulnerabilities)" >> security-status-report.md

    - name: Upload Security Status Report
      uses: actions/upload-artifact@v4
      with:
        name: security-status-report-${{ github.run_number }}
        path: security-status-report.md
        retention-days: 90

    # å‘é€å®‰å…¨çŠ¶æ€é€šçŸ¥ï¼ˆå¦‚æœé…ç½®äº†Slackï¼‰
    - name: Notify Security Status
      if: always() && env.SLACK_WEBHOOK != ''
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        channel: '#security'
        message: |
          ğŸ›¡ï¸ HuanuCanvas Security Status Report
          Repository: ${{ github.repository }}
          Branch: ${{ github.ref_name }}
          Status: ${{ job.status }}
          Security Score: ${{ env.SECURITY_SCORE || 'N/A' }}
          Report: Available in GitHub Actions artifacts