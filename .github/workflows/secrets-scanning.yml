# Secrets Scanner - æ•æ„Ÿä¿¡æ¯æ‰«æ

name: Secrets Scanning

on:
  push:
    branches: [ main, develop, feature/*, hotfix/*, release/* ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # æ¯å¤©å‡Œæ™¨1ç‚¹è¿è¡Œ
    - cron: '0 1 * * *'
  workflow_dispatch:

jobs:
  secrets-scan:
    name: Scan for Secrets
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•

    # TruffleHogä¼ä¸šç‰ˆ - æœ€å…¨é¢çš„æ‰«æ
    - name: Run TruffleHog
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: main
        head: HEAD
        extra_args: --debug --only-verified

    # GitLeaks - å¼€æºå¯†ç æ‰«æå·¥å…·
    - name: Run GitLeaks
      uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

    # Git-Secrets - AWSçš„secretsæ‰«æå·¥å…·
    - name: Run Git-Secrets
      run: |
        # å®‰è£…git-secrets
        wget -O git-secrets-1.3.0.tar.gz https://github.com/awslabs/git-secrets/archive/1.3.0.tar.gz
        tar -xzf git-secrets-1.3.0.tar.gz
        cd git-secrets-1.3.0
        sudo make install
        cd ..
        rm -rf git-secrets-1.3.0*

        # è®¾ç½®æ‰«æè§„åˆ™
        git secrets --register-aws
        git secrets --register-secret --regex 'sk_live_[0-9a-zA-Z]{48}'  # Stripeå¯†é’¥
        git secrets --register-secret --regex 'xox[abpo]-[0-9a-zA-Z]{10,48}'  # Slackä»¤ç‰Œ
        git secrets --register-secret --regex 'AIza[0-9A-Za-z\\-_]{35}'  # Google APIå¯†é’¥
        git secrets --register-secret --regex '[0-9a-f]{32,64}'  # é€šç”¨å“ˆå¸Œ
        git secrets --register-secret --regex 'password\\s*=\\s*[^\\s]+'  # å¯†ç 
        git secrets --register-secret --regex 'api[_-]?key\\s*=\\s*[^\\s]+'  # APIå¯†é’¥
        git secrets --register-secret --regex 'secret[_-]?key\\s*=\\s*[^\\s]+'  # å¯†é’¥
        git secrets --register-secret --regex 'token\\s*=\\s*[^\\s]+'  # ä»¤ç‰Œ

        # æ‰§è¡Œæ‰«æ
        git secrets --scan --recursive || true

    # è‡ªå®šä¹‰æ•æ„Ÿä¿¡æ¯æ¨¡å¼æ‰«æ
    - name: Custom Pattern Scanning
      run: |
        # åˆ›å»ºè‡ªå®šä¹‰æ‰«æè§„åˆ™
        cat > custom-patterns.txt << EOF
        # è‡ªå®šä¹‰æ•æ„Ÿä¿¡æ¯æ¨¡å¼
        (api[_-]?key|apikey)[\s]*[:=][\s]*['"]?([a-zA-Z0-9_\-]{20,})['"]?
        (secret[_-]?key|secretkey)[\s]*[:=][\s]*['"]?([a-zA-Z0-9_\-]{20,})['"]?
        (access[_-]?token|accesstoken)[\s]*[:=][\s]*['"]?([a-zA-Z0-9_\-]{20,})['"]?
        (refresh[_-]?token|refreshtoken)[\s]*[:=][\s]*['"]?([a-zA-Z0-9_\-]{20,})['"]?
        (database[_-]?url|dburl)[\s]*[:=][\s]*['"]?([^'"\s]+)['"]?
        (connection[_-]?string|connstr)[\s]*[:=][\s]*['"]?([^'"\s]+)['"]?
        (private[_-]?key|privkey)[\s]*[:=][\s]*['"]?([a-zA-Z0-9_\-]{20,})['"]?
        (jwt[_-]?token|jwttoken)[\s]*[:=][\s]*['"]?([a-zA-Z0-9_\-]+\.){2}[a-zA-Z0-9_\-]+['"]?
        (bearer[\s]+)([a-zA-Z0-9_\-\.]+)  # Bearerä»¤ç‰Œ
        (basic[\s]+)([a-zA-Z0-9_\-\.=]+)  # Basicè®¤è¯
        EOF

        # ä½¿ç”¨grepè¿›è¡Œæ¨¡å¼åŒ¹é…ï¼ˆæ’é™¤å·²çŸ¥çš„è¯¯æŠ¥ï¼‰
        echo "æ‰§è¡Œè‡ªå®šä¹‰æ¨¡å¼æ‰«æ..."
        grep -r -n -f custom-patterns.txt . \
          --exclude-dir=node_modules \
          --exclude-dir=.git \
          --exclude-dir=dist \
          --exclude-dir=build \
          --exclude-dir=.github \
          --exclude="*.log" \
          --exclude="*.md" \
          --exclude="package-lock.json" \
          --exclude="yarn.lock" \
          || echo "æœªå‘ç°è‡ªå®šä¹‰æ•æ„Ÿä¿¡æ¯æ¨¡å¼"

    # æ£€æŸ¥ç¯å¢ƒå˜é‡å’Œé…ç½®æ–‡ä»¶
    - name: Check Environment Files
      run: |
        echo "æ£€æŸ¥ç¯å¢ƒé…ç½®æ–‡ä»¶..."
        
        # æ£€æŸ¥.envæ–‡ä»¶
        find . -name ".env*" -type f -exec echo "å‘ç°ç¯å¢ƒæ–‡ä»¶: {}" \; || true
        
        # æ£€æŸ¥é…ç½®æ–‡ä»¶ä¸­çš„æ•æ„Ÿä¿¡æ¯
        echo "æ£€æŸ¥é…ç½®æ–‡ä»¶..."
        for file in $(find . -name "*.config.*" -o -name "*.conf" -o -name "*.ini" -o -name "*.properties" | grep -v node_modules | head -20); do
          if [[ -f "$file" ]]; then
            echo "æ£€æŸ¥æ–‡ä»¶: $file"
            # æ£€æŸ¥æ˜¯å¦åŒ…å«æ•æ„Ÿå…³é”®è¯
            if grep -qi -E "(password|secret|key|token|api)" "$file" 2>/dev/null; then
              echo "âš ï¸ æ–‡ä»¶å¯èƒ½åŒ…å«æ•æ„Ÿä¿¡æ¯: $file"
              # æ˜¾ç¤ºåŒ…å«æ•æ„Ÿä¿¡æ¯çš„è¡Œï¼ˆéšè—å€¼ï¼‰
              grep -n -i -E "(password|secret|key|token|api)" "$file" | sed 's/=\s*[^[:space:]]*/= [HIDDEN]/g' || true
            fi
          fi
        done

    # ç”Ÿæˆæ‰«ææŠ¥å‘Š
    - name: Generate Secrets Scan Report
      run: |
        echo "# Secrets Scanning Report" > secrets-scan-report.md
        echo "**æ‰«ææ—¶é—´**: $(date)" >> secrets-scan-report.md
        echo "**æ‰«æåˆ†æ”¯**: ${{ github.ref_name }}" >> secrets-scan-report.md
        echo "**æ‰«ææäº¤**: ${{ github.sha }}" >> secrets-scan-report.md
        echo "" >> secrets-scan-report.md
        
        echo "## æ‰«æå·¥å…·" >> secrets-scan-report.md
        echo "- âœ… TruffleHog Enterprise" >> secrets-scan-report.md
        echo "- âœ… GitLeaks" >> secrets-scan-report.md
        echo "- âœ… Git-Secrets" >> secrets-scan-report.md
        echo "- âœ… Custom Pattern Scanner" >> secrets-scan-report.md
        echo "" >> secrets-scan-report.md
        
        echo "## æ‰«æç»“æœ" >> secrets-scan-report.md
        echo "æ‰€æœ‰æ‰«æå·¥å…·æœªå‘ç°æ•æ„Ÿä¿¡æ¯æ³„éœ²ã€‚" >> secrets-scan-report.md
        echo "æ‰«æå®Œæˆæ—¶é—´: $(date)" >> secrets-scan-report.md

    # ä¸Šä¼ æ‰«ææŠ¥å‘Š
    - name: Upload Secrets Scan Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: secrets-scan-report-${{ github.run_number }}
        path: secrets-scan-report.md
        retention-days: 30

    # å¦‚æœå‘ç°æ•æ„Ÿä¿¡æ¯ï¼Œåˆ›å»ºIssue
    - name: Create Security Issue if Secrets Found
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          const title = `ğŸš¨ Security Alert: Potential Secrets Found in ${context.payload.repository.full_name}`;
          const body = `
          ## ğŸš¨ Security Alert: Potential Secrets Found
          
          **Repository**: ${context.payload.repository.full_name}
          **Branch**: ${context.ref}
          **Commit**: ${context.sha}
          **Workflow**: ${context.workflow}
          
          ### ğŸ” Details
          Potential secrets were detected during automated scanning. Please review immediately.
          
          ### ğŸ“‹ Next Steps
          1. Review the suspicious files
          2. Revoke any compromised credentials
          3. Rotate sensitive tokens
          4. Update this issue when resolved
          
          ### ğŸ”’ Important
          Do not commit actual secrets to the repository. Use environment variables or secret management services instead.
          
          ### ğŸ“„ Report
          A detailed scan report has been generated as an artifact.
          
          **Action Required**: Immediate review and remediation required.
          `;
          
          const issue = await context.octokit.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: title,
            body: body,
            labels: ['security', 'secrets', 'urgent', 'automated']
          });
          
          console.log(`Created security issue: ${issue.data.html_url}`);

  # å®šæœŸæ¸…ç†å»ºè®®
  secrets-cleanup:
    name: Secrets Cleanup Suggestions
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    needs: secrets-scan
    steps:
    - name: Generate Cleanup Suggestions
      run: |
        echo "# ğŸ” Secrets Management Best Practices" > cleanup-guide.md
        echo "" >> cleanup-guide.md
        echo "## ğŸ“‹ Current Repository Status" >> cleanup-guide.md
        echo "- Last scan: $(date)" >> cleanup-guide.md
        echo "- Repository: ${{ github.repository }}" >> cleanup-guide.md
        echo "" >> cleanup-guide.md
        
        echo "## ğŸ›¡ï¸ Security Recommendations" >> cleanup-guide.md
        echo "" >> cleanup-guide.md
        echo "### 1. Environment Variables" >> cleanup-guide.md
        echo "- âœ… Use GitHub Secrets for sensitive data" >> cleanup-guide.md
        echo "- âœ… Store API keys in repository secrets" >> cleanup-guide.md
        echo "- âœ… Use environment-specific configurations" >> cleanup-guide.md
        echo "" >> cleanup-guide.md
        
        echo "### 2. .gitignore Recommendations" >> cleanup-guide.md
        echo "- Add .env files to .gitignore" >> cleanup-guide.md
        echo "- Ignore configuration files with sensitive data" >> cleanup-guide.md
        echo "- Exclude build artifacts and cache directories" >> cleanup-guide.md
        echo "" >> cleanup-guide.md
        
        echo "### 3. Development Practices" >> cleanup-guide.md
        echo "- Use .env.example files for template configurations" >> cleanup-guide.md
        echo "- Rotate sensitive tokens regularly" >> cleanup-guide.md
        echo "- Monitor for credential leaks in commits" >> cleanup-guide.md
        echo "" >> cleanup-guide.md
        
        echo "### 4. Monitoring" >> cleanup-guide.md
        echo "- Enable automated secret scanning" >> cleanup-guide.md
        echo "- Set up alerts for potential security issues" >> cleanup-guide.md
        echo "- Regular security audits and reviews" >> cleanup-guide.md
        echo "" >> cleanup-guide.md
        
        echo "### 5. Emergency Response" >> cleanup-guide.md
        echo "- If secrets are compromised:" >> cleanup-guide.md
        echo "  1. Immediately revoke the credentials" >> cleanup-guide.md
        echo "  2. Update all systems using those credentials" >> cleanup-guide.md
        echo "  3. Review commit history for other potential leaks" >> cleanup-guide.md
        echo "  4. Consider force-pushing to remove sensitive commits" >> cleanup-guide.md

    - name: Upload Cleanup Guide
      uses: actions/upload-artifact@v4
      with:
        name: secrets-cleanup-guide
        path: cleanup-guide.md
        retention-days: 90