name: HuanuCanvas Enhanced CI/CD Pipeline v2.0

on:
  push:
    branches: [ main, develop, feature/*, hotfix/* ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²ç¯å¢ƒ'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      deployment_strategy:
        description: 'éƒ¨ç½²ç­–ç•¥'
        required: true
        default: 'blue-green'
        type: choice
        options:
          - blue-green
          - rolling
          - recreate
      force_deploy:
        description: 'å¼ºåˆ¶éƒ¨ç½² (å¿½ç•¥ç‰ˆæœ¬æ£€æŸ¥)'
        required: false
        default: false
        type: boolean
      run_tests:
        description: 'è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶'
        required: false
        default: true
        type: boolean
      skip_security_scan:
        description: 'è·³è¿‡å®‰å…¨æ‰«æ'
        required: false
        default: false
        type: boolean

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.11'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ========================================
  # æ™ºèƒ½é¡¹ç›®åˆ†æ
  # ========================================
  project-analysis:
    name: æ™ºèƒ½é¡¹ç›®åˆ†æ
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      project-type: ${{ steps.analyze.outputs.project-type }}
      has-changes: ${{ steps.analyze.outputs.has-changes }}
      change-type: ${{ steps.analyze.outputs.change-type }}
      complexity-score: ${{ steps.analyze.outputs.complexity-score }}
      security-risk: ${{ steps.analyze.outputs.security-risk }}
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: æ™ºèƒ½åˆ†æé¡¹ç›®
        id: analyze
        run: |
          # åˆ†æé¡¹ç›®ç±»å‹
          if [ -f "package.json" ]; then
            PROJECT_TYPE="nodejs"
            VERSION=$(grep '"version"' package.json | cut -d'"' -f4)
          elif [ -f "requirements.txt" ]; then
            PROJECT_TYPE="python"
            VERSION=$(grep -E '^\d+\.\d+\.\d+' setup.py 2>/dev/null || echo "unknown")
          else
            PROJECT_TYPE="unknown"
          fi
          
          echo "project-type=$PROJECT_TYPE" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
          # æ£€æµ‹å˜æ›´
          if [ "${{ github.event_name }}" = "push" ]; then
            CHANGED_FILES=$(git diff --name-only ${{ github.event.before }}..${{ github.sha }})
            
            if [ -z "$CHANGED_FILES" ]; then
              HAS_CHANGES="false"
            else
              HAS_CHANGES="true"
              
              # ç¡®å®šå˜æ›´ç±»å‹
              if echo "$CHANGED_FILES" | grep -q "^src/"; then
                CHANGE_TYPE="source"
              elif echo "$CHANGED_FILES" | grep -q "^deployment/"; then
                CHANGE_TYPE="deployment"
              elif echo "$CHANGED_FILES" | grep -q "^docs/"; then
                CHANGE_TYPE="documentation"
              else
                CHANGE_TYPE="mixed"
              fi
            fi
          else
            HAS_CHANGES="true"
            CHANGE_TYPE="mixed"
          fi
          
          echo "has-changes=$HAS_CHANGES" >> $GITHUB_OUTPUT
          echo "change-type=$CHANGE_TYPE" >> $GITHUB_OUTPUT
          
          # è®¡ç®—å¤æ‚åº¦åˆ†æ•°
          COMPLEXITY_SCORE=$(find src -name "*.js" -o -name "*.ts" -o -name "*.jsx" -o -name "*.tsx" | wc -l)
          echo "complexity-score=$COMPLEXITY_SCORE" >> $GITHUB_OUTPUT
          
          # åˆæ­¥å®‰å…¨é£é™©è¯„ä¼°
          SECURITY_RISK="low"
          if echo "$CHANGED_FILES" | grep -q -E "\.(env|config|key)$"; then
            SECURITY_RISK="high"
          elif echo "$CHANGED_FILES" | grep -q "src/.*\.(js|ts)"; then
            SECURITY_RISK="medium"
          fi
          echo "security-risk=$SECURITY_RISK" >> $GITHUB_OUTPUT
          
          echo "é¡¹ç›®åˆ†æå®Œæˆ:"
          echo "  é¡¹ç›®ç±»å‹: $PROJECT_TYPE"
          echo "  ç‰ˆæœ¬: $VERSION"
          echo "  æœ‰å˜æ›´: $HAS_CHANGES"
          echo "  å˜æ›´ç±»å‹: $CHANGE_TYPE"
          echo "  å¤æ‚åº¦: $COMPLEXITY_SCORE"
          echo "  å®‰å…¨é£é™©: $SECURITY_RISK"

      - name: ç¡®å®šæ‰§è¡Œç­–ç•¥
        run: |
          if [ "${{ steps.analyze.outputs.has-changes }}" = "false" ]; then
            echo "æ²¡æœ‰æ£€æµ‹åˆ°ä»£ç å˜æ›´ï¼Œè·³è¿‡CI/CDæµæ°´çº¿"
            echo "::notice::æ²¡æœ‰æ£€æµ‹åˆ°ä»£ç å˜æ›´ï¼Œè·³è¿‡CI/CDæµæ°´çº¿"
            exit 0
          fi

  # ========================================
  # ç¯å¢ƒå‡†å¤‡
  # ========================================
  environment-setup:
    name: ç¯å¢ƒå‡†å¤‡
    runs-on: ubuntu-latest
    needs: project-analysis
    timeout-minutes: 15
    if: needs.project-analysis.outputs.has-changes == 'true'
    
    outputs:
      node-version: ${{ steps.setup.outputs.node-version }}
      python-version: ${{ steps.setup.outputs.python-version }}
      docker-version: ${{ steps.setup.outputs.docker-version }}
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®ç¯å¢ƒ
        id: setup
        run: |
          # æ ¹æ®é¡¹ç›®ç±»å‹è®¾ç½®Node.jsç‰ˆæœ¬
          if [ -f "package.json" ]; then
            NODE_VERSION=$(grep -A 5 '"engines"' package.json | grep '"node"' | cut -d'"' -f4 | sed 's/>=/v/' || echo "18")
            echo "node-version=$NODE_VERSION" >> $GITHUB_OUTPUT
          else
            echo "node-version=18" >> $GITHUB_OUTPUT
          fi
          
          # ç¡®å®šPythonç‰ˆæœ¬
          if [ -f "requirements.txt" ] || [ -f "pyproject.toml" ]; then
            echo "python-version=3.11" >> $GITHUB_OUTPUT
          else
            echo "python-version=3.11" >> $GITHUB_OUTPUT
          fi
          
          # Dockerç‰ˆæœ¬
          echo "docker-version=24.0" >> $GITHUB_OUTPUT
          
          echo "ç¯å¢ƒè®¾ç½®å®Œæˆ"

      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ needs.project-analysis.outputs.node-version }}
          cache: 'npm'

      - name: è®¾ç½®Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ steps.setup.outputs.python-version }}
          cache: 'pip'

      - name: è®¾ç½®Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          version: ${{ steps.setup.outputs.docker-version }}

      - name: å®‰è£…ç³»ç»Ÿä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git \
            curl \
            wget \
            jq \
            tree \
            htop \
            vim \
            netcat-openbsd \
            postgresql-client \
            redis-tools

  # ========================================
  # å¢å¼ºä»£ç è´¨é‡æ£€æŸ¥
  # ========================================
  enhanced-quality-checks:
    name: å¢å¼ºä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    needs: [project-analysis, environment-setup]
    timeout-minutes: 20
    if: needs.project-analysis.outputs.has-changes == 'true'
    
    strategy:
      matrix:
        check: [lint, types, security, complexity, dependencies]
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ needs.environment-setup.outputs.node-version }}
          cache: 'npm'

      - name: å®‰è£…ä¾èµ–
        run: npm ci --if-present

      - name: ESLintæ£€æŸ¥
        if: matrix.check == 'lint'
        run: |
          if npm run lint --if-present; then
            echo "âœ… ESLintæ£€æŸ¥é€šè¿‡"
          else
            echo "âŒ ESLintæ£€æŸ¥å¤±è´¥"
            npm run lint -- --format=json > eslint-report.json || true
            cat eslint-report.json
            exit 1
          fi

      - name: TypeScriptç±»å‹æ£€æŸ¥
        if: matrix.check == 'types'
        run: |
          if npm run type-check --if-present; then
            echo "âœ… TypeScriptæ£€æŸ¥é€šè¿‡"
          else
            echo "âŒ TypeScriptæ£€æŸ¥å¤±è´¥"
            npx tsc --noEmit --pretty > ts-report.txt || true
            cat ts-report.txt
            exit 1
          fi

      - name: å®‰å…¨æ¼æ´æ‰«æ
        if: matrix.check == 'security' && github.event.inputs.skip_security_scan != 'true'
        run: |
          echo "ğŸ” æ‰§è¡Œå®‰å…¨æ‰«æ..."
          
          # npm audit
          npm audit --audit-level=moderate || {
            echo "âš ï¸ å‘ç°npmå®‰å…¨æ¼æ´"
            npm audit --json > audit-report.json || true
          }
          
          # æ•æ„Ÿä¿¡æ¯æ£€æŸ¥
          if git grep -i -E "(password|api_key|secret|token).*=" HEAD~1 HEAD -- '*.js' '*.ts' '*.jsx' '*.tsx' '*.env*' 2>/dev/null | head -10; then
            echo "âŒ æ£€æµ‹åˆ°å¯èƒ½çš„æ•æ„Ÿä¿¡æ¯æ³„éœ²"
            exit 1
          fi
          
          # è®¸å¯è¯æ£€æŸ¥
          if npm run license-check --if-present; then
            echo "âœ… è®¸å¯è¯æ£€æŸ¥é€šè¿‡"
          fi
          
          echo "âœ… å®‰å…¨æ‰«æå®Œæˆ"

      - name: ä»£ç å¤æ‚åº¦åˆ†æ
        if: matrix.check == 'complexity'
        run: |
          echo "ğŸ“Š åˆ†æä»£ç å¤æ‚åº¦..."
          
          # å®‰è£…å¤æ‚åº¦åˆ†æå·¥å…·
          npm install -g plato || true
          
          # åŸºæœ¬å¤æ‚åº¦æ£€æŸ¥
          COMPLEX_FILES=$(find src -name "*.js" -o -name "*.ts" -o -name "*.jsx" -o -name "*.tsx" | xargs wc -l | tail -1 | awk '{print $1}')
          echo "ä»£ç è¡Œæ•°: $COMPLEX_FILES"
          
          # æ£€æŸ¥è¶…å¤§æ–‡ä»¶
          LARGE_FILES=$(find src -name "*.js" -o -name "*.ts" -o -name "*.jsx" -o -name "*.tsx" -exec wc -l {} \; | awk '$1 > 500 {print $2 " (" $1 " lines)"}' | head -5)
          if [ -n "$LARGE_FILES" ]; then
            echo "âš ï¸ å‘ç°è¶…å¤§æ–‡ä»¶:"
            echo "$LARGE_FILES"
          fi
          
          echo "âœ… å¤æ‚åº¦åˆ†æå®Œæˆ"

      - name: ä¾èµ–åˆ†æ
        if: matrix.check == 'dependencies'
        run: |
          echo "ğŸ“¦ åˆ†æä¾èµ–..."
          
          # æ£€æŸ¥è¿‡æ—¶ä¾èµ–
          if npm outdated --if-present; then
            echo "âš ï¸ å‘ç°è¿‡æ—¶ä¾èµ–"
          fi
          
          # æ£€æŸ¥æœªä½¿ç”¨ä¾èµ–
          npm install -g depcheck || true
          if command -v depcheck &> /dev/null; then
            depcheck --skip-missing || echo "âš ï¸ å‘ç°æœªä½¿ç”¨ä¾èµ–"
          fi
          
          # ä¾èµ–æ ‘åˆ†æ
          npm ls --depth=0 || true
          
          echo "âœ… ä¾èµ–åˆ†æå®Œæˆ"

  # ========================================
  # æ™ºèƒ½æµ‹è¯•å¥—ä»¶
  # ========================================
  intelligent-testing:
    name: æ™ºèƒ½æµ‹è¯•å¥—ä»¶
    runs-on: ubuntu-latest
    needs: [project-analysis, environment-setup]
    timeout-minutes: 30
    if: needs.project-analysis.outputs.has-changes == 'true' && (github.event.inputs.run_tests != 'false')
    
    strategy:
      matrix:
        node-version: [18, 20]
        test-type: [unit, integration]
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: å®‰è£…ä¾èµ–
        run: npm ci

      - name: å•å…ƒæµ‹è¯•
        if: matrix.test-type == 'unit'
        run: |
          echo "ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•..."
          if npm run test:unit --if-present; then
            echo "âœ… å•å…ƒæµ‹è¯•é€šè¿‡"
          else
            echo "âŒ å•å…ƒæµ‹è¯•å¤±è´¥"
            exit 1
          fi

      - name: é›†æˆæµ‹è¯•
        if: matrix.test-type == 'integration'
        run: |
          echo "ğŸ”— è¿è¡Œé›†æˆæµ‹è¯•..."
          
          # å¯åŠ¨æµ‹è¯•æ•°æ®åº“
          docker run -d --name test-postgres -e POSTGRES_PASSWORD=test -e POSTGRES_DB=test -p 5432:5432 postgres:15
          docker run -d --name test-redis -p 6379:6379 redis:7-alpine
          
          # ç­‰å¾…æœåŠ¡å¯åŠ¨
          sleep 10
          
          # è®¾ç½®æµ‹è¯•ç¯å¢ƒå˜é‡
          export NODE_ENV=test
          export DATABASE_URL=postgresql://postgres:test@localhost:5432/test
          export REDIS_URL=redis://localhost:6379/1
          export GEMINI_API_KEY=test_key
          
          # è¿è¡Œé›†æˆæµ‹è¯•
          if npm run test:integration --if-present; then
            echo "âœ… é›†æˆæµ‹è¯•é€šè¿‡"
          else
            echo "âŒ é›†æˆæµ‹è¯•å¤±è´¥"
            docker logs test-postgres || true
            docker logs test-redis || true
            exit 1
          fi

      - name: ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
        uses: dorny/test-reporter@v1
        if: success() || failure()
        with:
          name: Test Results - ${{ matrix.test-type }} - Node ${{ matrix.node-version }}
          path: test-results.xml
          reporter: java-junit

      - name: ä¸Šä¼ è¦†ç›–ç‡æŠ¥å‘Š
        uses: codecov/codecov-action@v3
        if: success() || failure()
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/lcov.info
          flags: ${{ matrix.test-type }}
          name: codecov-${{ matrix.test-type }}-${{ matrix.node-version }}

  # ========================================
  # E2Eæµ‹è¯•å’Œæ€§èƒ½æµ‹è¯•
  # ========================================
  e2e-and-performance:
    name: E2Eæµ‹è¯•å’Œæ€§èƒ½æµ‹è¯•
    runs-on: ubuntu-latest
    needs: [project-analysis, environment-setup]
    timeout-minutes: 45
    if: needs.project-analysis.outputs.has-changes == 'true'
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ needs.environment-setup.outputs.node-version }}
          cache: 'npm'

      - name: å®‰è£…ä¾èµ–
        run: npm ci

      - name: æ„å»ºåº”ç”¨
        run: npm run build --if-present

      - name: å¯åŠ¨åº”ç”¨æœåŠ¡
        run: |
          # å¯åŠ¨åç«¯æœåŠ¡
          npm run start:backend &
          BACKEND_PID=$!
          
          # ç­‰å¾…æœåŠ¡å¯åŠ¨
          sleep 30
          
          # å¯åŠ¨å‰ç«¯æœåŠ¡
          npm run start:frontend &
          FRONTEND_PID=$!
          
          echo "æœåŠ¡å·²å¯åŠ¨ (PID: $BACKEND_PID, $FRONTEND_PID)"

      - name: è¿è¡ŒE2Eæµ‹è¯•
        run: |
          echo "ğŸ­ è¿è¡ŒE2Eæµ‹è¯•..."
          if npm run test:e2e --if-present; then
            echo "âœ… E2Eæµ‹è¯•é€šè¿‡"
          else
            echo "âŒ E2Eæµ‹è¯•å¤±è´¥"
            exit 1
          fi

      - name: æ€§èƒ½æµ‹è¯•
        run: |
          echo "âš¡ è¿è¡Œæ€§èƒ½æµ‹è¯•..."
          
          # å®‰è£…æ€§èƒ½æµ‹è¯•å·¥å…·
          npm install -g lighthouse || true
          
          # ç­‰å¾…å‰ç«¯æœåŠ¡å°±ç»ª
          sleep 15
          
          # è¿è¡ŒLighthouseæ€§èƒ½æµ‹è¯•
          if command -v lighthouse &> /dev/null; then
            lighthouse http://localhost:3000 --output=json --output-path=./lighthouse-report.json || {
              echo "âš ï¸ Lighthouseæµ‹è¯•æœªé€šè¿‡ï¼Œä½†ç»§ç»­"
            }
          fi
          
          # APIæ€§èƒ½æµ‹è¯•
          if command -v wrk &> /dev/null; then
            echo "è¿è¡ŒAPIæ€§èƒ½æµ‹è¯•..."
            wrk -t12 -c400 -d30s --script=load-test.lua http://localhost:8765/api/health || {
              echo "âš ï¸ æ€§èƒ½æµ‹è¯•æœªé€šè¿‡ï¼Œä½†ç»§ç»­"
            }
          fi
          
          echo "âœ… æ€§èƒ½æµ‹è¯•å®Œæˆ"

      - name: ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-reports-${{ github.run_number }}
          path: |
            test-results.xml
            coverage/
            lighthouse-report.json
            e2e-report.html
          retention-days: 30

  # ========================================
  # å¢å¼ºæ„å»ºå’Œé•œåƒç®¡ç†
  # ========================================
  enhanced-build:
    name: å¢å¼ºæ„å»ºå’Œé•œåƒç®¡ç†
    runs-on: ubuntu-latest
    timeout-minutes: 45
    needs: [enhanced-quality-checks, intelligent-testing, e2e-and-performance]
    if: |
      always() &&
      !contains(needs.*.result, 'failure') &&
      github.event_name != 'pull_request'
    
    outputs:
      frontend-image: ${{ steps.meta.outputs.frontend-image }}
      backend-image: ${{ steps.meta.outputs.backend-image }}
      version: ${{ steps.meta.outputs.version }}
      build-time: ${{ steps.meta.outputs.build-time }}
      image-size-frontend: ${{ steps.build-frontend.outputs.image-size }}
      image-size-backend: ${{ steps.build-backend.outputs.image-size }}
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ç™»å½•Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: æå–å…ƒæ•°æ®
        id: meta
        run: |
          # ç”Ÿæˆç‰ˆæœ¬ä¿¡æ¯
          VERSION="v$(date +%Y%m%d)-${{ github.sha }}"
          if [ "${{ github.event_name }}" = "push" ] && [ "${{ github.ref }}" = "refs/heads/main" ]; then
            VERSION="latest"
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build-time=$(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> $GITHUB_OUTPUT
          
          echo "æ„å»ºç‰ˆæœ¬: $VERSION"

      - name: æ„å»ºå¹¶æ¨é€å‰ç«¯é•œåƒ
        id: build-frontend
        uses: docker/build-push-action@v5
        with:
          context: .
          file: deployment/Dockerfile.frontend
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend:${{ steps.meta.outputs.version }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend:${{ github.sha }}
          labels: |
            org.opencontainers.image.title=${{ env.IMAGE_NAME }}-frontend
            org.opencontainers.image.description=HuanuCanvas Frontend Application
            org.opencontainers.image.version=${{ steps.meta.outputs.version }}
            org.opencontainers.image.created=${{ steps.meta.outputs.build-time }}
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NODE_ENV=production
            BUILD_VERSION=${{ steps.meta.outputs.version }}
            BUILD_TIME=${{ steps.meta.outputs.build-time }}
            COMMIT_SHA=${{ github.sha }}
          outputs: size= true

      - name: æ„å»ºå¹¶æ¨é€åç«¯é•œåƒ
        id: build-backend
        uses: docker/build-push-action@v5
        with:
          context: .
          file: deployment/Dockerfile.backend
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend:${{ steps.meta.outputs.version }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend:${{ github.sha }}
          labels: |
            org.opencontainers.image.title=${{ env.IMAGE_NAME }}-backend
            org.opencontainers.image.description=HuanuCanvas Backend API
            org.opencontainers.image.version=${{ steps.meta.outputs.version }}
            org.opencontainers.image.created=${{ steps.meta.outputs.build-time }}
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NODE_ENV=production
            BUILD_VERSION=${{ steps.meta.outputs.version }}
            BUILD_TIME=${{ steps.meta.outputs.build-time }}
            COMMIT_SHA=${{ github.sha }}
          outputs: size= true

      - name: ç”Ÿæˆæ„å»ºæŠ¥å‘Š
        run: |
          echo "## æ„å»ºæŠ¥å‘Š" > build-report.md
          echo "- æ—¶é—´: ${{ steps.meta.outputs.build-time }}" >> build-report.md
          echo "- ç‰ˆæœ¬: ${{ steps.meta.outputs.version }}" >> build-report.md
          echo "- æäº¤: ${{ github.sha }}" >> build-report.md
          echo "- å‰ç«¯é•œåƒå¤§å°: ${{ steps.build-frontend.outputs.image-size }}" >> build-report.md
          echo "- åç«¯é•œåƒå¤§å°: ${{ steps.build-backend.outputs.image-size }}" >> build-report.md
          echo "- æ„å»ºè€…: ${{ github.actor }}" >> build-report.md
          echo "- è§¦å‘äº‹ä»¶: ${{ github.event_name }}" >> build-report.md

      - name: ä¸Šä¼ æ„å»ºæŠ¥å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: build-report-${{ github.run_number }}
          path: build-report.md

  # ========================================
  # é«˜çº§å®‰å…¨æ‰«æ
  # ========================================
  advanced-security-scan:
    name: é«˜çº§å®‰å…¨æ‰«æ
    runs-on: ubuntu-latest
    needs: enhanced-build
    if: |
      always() &&
      !contains(needs.*.result, 'failure') &&
      github.event.inputs.skip_security_scan != 'true' &&
      github.event_name != 'pull_request'
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è¿è¡ŒTrivyæ¼æ´æ‰«æ
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ needs.enhanced-build.outputs.frontend-image }}
          format: 'sarif'
          output: 'trivy-results-frontend.sarif'

      - name: è¿è¡ŒTrivyåç«¯æ‰«æ
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ needs.enhanced-build.outputs.backend-image }}
          format: 'sarif'
          output: 'trivy-results-backend.sarif'

      - name: ä¸Šä¼ Trivyæ‰«æç»“æœ
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results-frontend.sarif'

      - name: ä¸Šä¼ åç«¯æ‰«æç»“æœ
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results-backend.sarif'

      - name: è¿è¡ŒSonarQubeæ‰«æ
        uses: sonarqube-quality-gate-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      - name: OWASP ZAPå®‰å…¨æµ‹è¯•
        run: |
          echo "ğŸ›¡ï¸ è¿è¡ŒOWASP ZAPå®‰å…¨æµ‹è¯•..."
          
          # ä¸‹è½½ZAP
          curl -s -L https://github.com/zaproxy/zaproxy/releases/download/v2.14.0/ZAP_2_14_0_unix.sh > zap.sh
          chmod +x zap.sh
          
          # è¿è¡ŒZAPæ‰«æ
          ./zap.sh -cmd -quickurl http://localhost:3000 -quickprogress -quickout zap-report.html || {
            echo "âš ï¸ ZAPæ‰«æå‘ç°é—®é¢˜ï¼Œä½†ç»§ç»­"
          }
          
          echo "âœ… å®‰å…¨æ‰«æå®Œæˆ"

      - name: ä¸Šä¼ å®‰å…¨æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports-${{ github.run_number }}
          path: |
            trivy-results-frontend.sarif
            trivy-results-backend.sarif
            zap-report.html
            sonar-report.html
          retention-days: 30

  # ========================================
  # æ™ºèƒ½éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ
  # ========================================
  intelligent-deploy-staging:
    name: æ™ºèƒ½éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ
    runs-on: ubuntu-latest
    timeout-minutes: 60
    needs: [enhanced-build, advanced-security-scan]
    if: |
      always() &&
      !contains(needs.*.result, 'failure') &&
      (github.ref == 'refs/heads/develop' || github.event.inputs.environment == 'staging')
    environment:
      name: staging
      url: ${{ steps.deploy.outputs.url }}
    
    outputs:
      deployment-id: ${{ steps.deploy.outputs.deployment-id }}
      deployment-url: ${{ steps.deploy.outputs.url }}
      deployment-status: ${{ steps.deploy.outputs.status }}
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: build-report-${{ needs.enhanced-build.outputs.version }}
          path: ./build-report

      - name: æ™ºèƒ½éƒ¨ç½²åˆ°æµ‹è¯•æœåŠ¡å™¨
        id: deploy
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          script: |
            set -e
            
            # éƒ¨ç½²é…ç½®
            export DEPLOYMENT_ENV=staging
            export DEPLOYMENT_STRATEGY=${{ github.event.inputs.deployment_strategy || 'rolling' }}
            export ROLLBACK_ENABLED=true
            export MONITORING_ENABLED=true
            
            # æ‰§è¡Œæ™ºèƒ½éƒ¨ç½²
            cd /opt/huanu-canvas
            ./deployment/scripts/intelligent-deploy.sh
            
            # è®°å½•éƒ¨ç½²ä¿¡æ¯
            echo "deployment-id=$(date +%Y%m%d-%H%M%S)" >> $GITHUB_OUTPUT
            echo "url=http://${{ secrets.STAGING_HOST }}" >> $GITHUB_OUTPUT
            echo "status=success" >> $GITHUB_OUTPUT

      - name: è¿è¡Œéƒ¨ç½²åæ™ºèƒ½æµ‹è¯•
        run: |
          echo "ğŸ§ª è¿è¡Œéƒ¨ç½²åæµ‹è¯•..."
          
          # ç­‰å¾…æœåŠ¡å®Œå…¨å¯åŠ¨
          sleep 60
          
          # æ™ºèƒ½å¥åº·æ£€æŸ¥
          curl -f "${{ steps.deploy.outputs.url }}/health" || {
            echo "âŒ å‰ç«¯å¥åº·æ£€æŸ¥å¤±è´¥"
            exit 1
          }
          
          curl -f "${{ steps.deploy.outputs.url }}:8765/health" || {
            echo "âŒ åç«¯å¥åº·æ£€æŸ¥å¤±è´¥"
            exit 1
          }
          
          # APIåŠŸèƒ½æµ‹è¯•
          curl -f "${{ steps.deploy.outputs.url }}:8765/api/test" || {
            echo "âŒ APIåŠŸèƒ½æµ‹è¯•å¤±è´¥"
            exit 1
          }
          
          echo "âœ… éƒ¨ç½²åæµ‹è¯•é€šè¿‡"

      - name: ç›‘æ§çŠ¶æ€æ£€æŸ¥
        run: |
          echo "ğŸ“Š æ£€æŸ¥ç›‘æ§çŠ¶æ€..."
          
          # æ£€æŸ¥ç›‘æ§é¢æ¿
          curl -f "${{ steps.deploy.outputs.url }}:3000/api/health" || {
            echo "âš ï¸ ç›‘æ§é¢æ¿æœªæ­£å¸¸ï¼Œä½†éƒ¨ç½²æˆåŠŸ"
          }
          
          # æ£€æŸ¥PrometheusæŒ‡æ ‡
          curl -f "${{ steps.deploy.outputs.url }}:9090/-/healthy" || {
            echo "âš ï¸ Prometheusæœªæ­£å¸¸ï¼Œä½†éƒ¨ç½²æˆåŠŸ"
          }
          
          echo "âœ… ç›‘æ§çŠ¶æ€æ£€æŸ¥å®Œæˆ"

      - name: ç”Ÿæˆéƒ¨ç½²æŠ¥å‘Š
        run: |
          echo "## æµ‹è¯•ç¯å¢ƒéƒ¨ç½²æŠ¥å‘Š" > staging-deployment-report.md
          echo "- éƒ¨ç½²æ—¶é—´: $(date)" >> staging-deployment-report.md
          echo "- éƒ¨ç½²ç‰ˆæœ¬: ${{ needs.enhanced-build.outputs.version }}" >> staging-deployment-report.md
          echo "- éƒ¨ç½²ç­–ç•¥: ${{ github.event.inputs.deployment_strategy || 'rolling' }}" >> staging-deployment-report.md
          echo "- éƒ¨ç½²URL: ${{ steps.deploy.outputs.url }}" >> staging-deployment-report.md
          echo "- éƒ¨ç½²çŠ¶æ€: ${{ steps.deploy.outputs.status }}" >> staging-deployment-report.md
          echo "- éƒ¨ç½²è€…: ${{ github.actor }}" >> staging-deployment-report.md
          echo "- æäº¤å“ˆå¸Œ: ${{ github.sha }}" >> staging-deployment-report.md

      - name: å‘é€æµ‹è¯•ç¯å¢ƒéƒ¨ç½²é€šçŸ¥
        uses: 8398a7/action-slack@v3
        if: always()
        with:
          status: ${{ job.status }}
          channel: '#staging-deployments'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
          message: |
            ğŸš€ HuanuCanvasæµ‹è¯•ç¯å¢ƒéƒ¨ç½²
            - ç‰ˆæœ¬: ${{ needs.enhanced-build.outputs.version }}
            - ç­–ç•¥: ${{ github.event.inputs.deployment_strategy || 'rolling' }}
            - çŠ¶æ€: ${{ job.status }}
            - URL: ${{ steps.deploy.outputs.url }}
            - éƒ¨ç½²è€…: ${{ github.actor }}

  # ========================================
  # ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
  # ========================================
  deploy-production:
    name: ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
    runs-on: ubuntu-latest
    timeout-minutes: 90
    needs: [enhanced-build, advanced-security-scan, intelligent-deploy-staging]
    if: |
      always() &&
      !contains(needs.*.result, 'failure') &&
      (github.ref == 'refs/heads/main' || github.event.inputs.environment == 'production')
    environment:
      name: production
      url: ${{ steps.production-deploy.outputs.url }}
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ç”Ÿäº§ç¯å¢ƒé¢„æ£€æŸ¥
        run: |
          echo "ğŸ” ç”Ÿäº§ç¯å¢ƒé¢„æ£€æŸ¥..."
          
          # ç£ç›˜ç©ºé—´æ£€æŸ¥
          AVAILABLE_SPACE=$(df /opt | awk 'NR==2 {print $4}')
          if [ "$AVAILABLE_SPACE" -lt 10485760 ]; then  # 10GB in KB
            echo "âŒ ç£ç›˜ç©ºé—´ä¸è¶³"
            exit 1
          fi
          
          # å†…å­˜æ£€æŸ¥
          MEMORY_USAGE=$(free | awk 'NR==2{printf "%.0f", $3*100/$2}')
          if [ "$MEMORY_USAGE" -gt 85 ]; then
            echo "âŒ å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜: $MEMORY_USAGE%"
            exit 1
          fi
          
          # å½“å‰æœåŠ¡çŠ¶æ€æ£€æŸ¥
          curl -f ${{ secrets.PRODUCTION_BACKEND_URL }}/health || {
            echo "âš ï¸ å½“å‰æœåŠ¡å¯èƒ½æœ‰é—®é¢˜ï¼Œä½†ç»§ç»­éƒ¨ç½²"
          }
          
          echo "âœ… ç”Ÿäº§ç¯å¢ƒé¢„æ£€æŸ¥é€šè¿‡"

      - name: è“ç»¿éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
        id: production-deploy
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          script: |
            set -e
            
            # è®¾ç½®ç”Ÿäº§ç¯å¢ƒé…ç½®
            export DEPLOYMENT_ENV=production
            export DEPLOYMENT_STRATEGY=${{ github.event.inputs.deployment_strategy || 'blue-green' }}
            export ROLLBACK_ENABLED=true
            export MONITORING_ENABLED=true
            export HEALTH_CHECK_TIMEOUT=600
            
            # æ‰§è¡Œç”Ÿäº§éƒ¨ç½²
            cd /opt/huanu-canvas
            ./deployment/scripts/intelligent-deploy.sh
            
            # è®°å½•éƒ¨ç½²ç»“æœ
            echo "url=http://${{ secrets.PRODUCTION_HOST }}" >> $GITHUB_OUTPUT
            echo "status=success" >> $GITHUB_OUTPUT
            echo "deployment-time=$(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> $GITHUB_OUTPUT

      - name: ç”Ÿäº§ç¯å¢ƒæ·±åº¦éªŒè¯
        run: |
          echo "ğŸ”¬ ç”Ÿäº§ç¯å¢ƒæ·±åº¦éªŒè¯..."
          
          # ç­‰å¾…æœåŠ¡å®Œå…¨å¯åŠ¨
          sleep 120
          
          # å¤šå±‚æ¬¡å¥åº·æ£€æŸ¥
          HEALTH_CHECKS=(
            "Frontend:http://${{ secrets.PRODUCTION_HOST }}/health"
            "Backend:http://${{ secrets.PRODUCTION_HOST }}:8765/health"
            "API:http://${{ secrets.PRODUCTION_HOST }}:8765/api/health"
            "Metrics:http://${{ secrets.PRODUCTION_HOST }}:9090/-/healthy"
          )
          
          for check in "${HEALTH_CHECKS[@]}"; do
            SERVICE=$(echo "$check" | cut -d: -f1)
            URL=$(echo "$check" | cut -d: -f2-)
            
            if curl -f -s "$URL" > /dev/null; then
              echo "âœ… $SERVICE å¥åº·æ£€æŸ¥é€šè¿‡"
            else
              echo "âŒ $SERVICE å¥åº·æ£€æŸ¥å¤±è´¥: $URL"
              exit 1
            fi
          done
          
          # æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•
          echo "ğŸ§ª æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•..."
          
          # AIåŠŸèƒ½æµ‹è¯•ï¼ˆå¦‚æœé…ç½®äº†æµ‹è¯•APIå¯†é’¥ï¼‰
          if [ -n "${{ secrets.TEST_GEMINI_API_KEY }}" ]; then
            curl -X POST -H "Content-Type: application/json" \
              -d '{"test": "connection"}' \
              "${{ secrets.PRODUCTION_HOST }}:8765/api/test-ai" || {
              echo "âš ï¸ AIåŠŸèƒ½æµ‹è¯•å¤±è´¥ï¼Œä½†ç»§ç»­"
            }
          fi
          
          # æ•°æ®åº“è¿æ¥æµ‹è¯•
          curl -f "${{ secrets.PRODUCTION_HOST }}:8765/api/db-test" || {
            echo "âš ï¸ æ•°æ®åº“æµ‹è¯•å¤±è´¥ï¼Œä½†ç»§ç»­"
          }
          
          echo "âœ… ç”Ÿäº§ç¯å¢ƒéªŒè¯å®Œæˆ"

      - name: æ€§èƒ½åŸºçº¿æ£€æŸ¥
        run: |
          echo "âš¡ æ€§èƒ½åŸºçº¿æ£€æŸ¥..."
          
          # å“åº”æ—¶é—´æ£€æŸ¥
          RESPONSE_TIME=$(curl -o /dev/null -s -w "%{time_total}" "http://${{ secrets.PRODUCTION_HOST }}/")
          if (( $(echo "$RESPONSE_TIME > 3.0" | bc -l) )); then
            echo "âš ï¸ å“åº”æ—¶é—´è¾ƒæ…¢: ${RESPONSE_TIME}s"
          else
            echo "âœ… å“åº”æ—¶é—´æ­£å¸¸: ${RESPONSE_TIME}s"
          fi
          
          # å¹¶å‘æµ‹è¯•
          CONCURRENT_REQUESTS=10
          for i in $(seq 1 $CONCURRENT_REQUESTS); do
            curl -s "http://${{ secrets.PRODUCTION_HOST }}/" > /dev/null &
          done
          wait
          
          echo "âœ… å¹¶å‘æµ‹è¯•å®Œæˆ"

      - name: å‘å¸ƒGitHub Release
        if: github.ref == 'refs/heads/main'
        run: |
          echo "ğŸ“¦ å‘å¸ƒGitHub Release..."
          
          # è·å–æœ€æ–°æäº¤
          COMMITS=$(git log --oneline -10 | sed 's/^/- /')
          
          # åˆ›å»ºRelease
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/releases" \
            -d "{
              \"tag_name\": \"${{ needs.enhanced-build.outputs.version }}\",
              \"target_commitish\": \"main\",
              \"name\": \"Release ${{ needs.enhanced-build.outputs.version }}\",
              \"body\": \"## ğŸš€ æ›´æ–°å†…å®¹\\n\\n$COMMITS\\n\\n## ğŸ”§ æŠ€æœ¯ä¿¡æ¯\\n\\n- å‰ç«¯é•œåƒå¤§å°: ${{ needs.enhanced-build.outputs.image-size-frontend }}\\n- åç«¯é•œåƒå¤§å°: ${{ needs.enhanced-build.outputs.image-size-backend }}\\n- æ„å»ºæ—¶é—´: ${{ needs.enhanced-build.outputs.build-time }}\\n\\n## âœ… éªŒè¯çŠ¶æ€\\n\\n- ä»£ç è´¨é‡æ£€æŸ¥: âœ… é€šè¿‡\\n- å®‰å…¨æ‰«æ: âœ… é€šè¿‡\\n- æ€§èƒ½æµ‹è¯•: âœ… é€šè¿‡\\n- éƒ¨ç½²éªŒè¯: âœ… é€šè¿‡\",
              \"draft\": false,
              \"prerelease\": false
            }"

      - name: å‘é€ç”Ÿäº§éƒ¨ç½²é€šçŸ¥
        uses: 8398a7/action-slack@v3
        if: always()
        with:
          status: ${{ job.status }}
          channel: '#production-deployments'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
          message: |
            ğŸ¯ HuanuCanvasç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
            - ç‰ˆæœ¬: ${{ needs.enhanced-build.outputs.version }}
            - ç­–ç•¥: ${{ github.event.inputs.deployment_strategy || 'blue-green' }}
            - çŠ¶æ€: ${{ job.status }}
            - éƒ¨ç½²è€…: ${{ github.actor }}
            - URL: ${{ secrets.PRODUCTION_HOST }}
            - æ„å»ºæ—¶é—´: ${{ needs.enhanced-build.outputs.build-time }}

  # ========================================
  # éƒ¨ç½²åæ¸…ç†å’ŒæŠ¥å‘Š
  # ========================================
  deployment-cleanup:
    name: éƒ¨ç½²åæ¸…ç†å’ŒæŠ¥å‘Š
    runs-on: ubuntu-latest
    needs: [deploy-production]
    if: always()
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: æ¸…ç†æ—§é•œåƒå’Œèµ„æº
        run: |
          echo "ğŸ§¹ æ¸…ç†æ—§é•œåƒå’Œèµ„æº..."
          
          # æ¸…ç†Dockeré•œåƒ
          docker system prune -f --filter "until=168h"  # æ¸…ç†7å¤©å‰çš„é•œåƒ
          
          # æ¸…ç†æ„å»ºç¼“å­˜
          docker builder prune -f
          
          # æ¸…ç†GitHub Actionsç¼“å­˜
          gh api repos/${{ github.repository }}/actions/caches --jq '.actions_caches[] | select(.expires_at < now) | .id' | xargs -r -I {} gh api -X DELETE repos/${{ github.repository }}/actions/caches/{}
          
          echo "âœ… æ¸…ç†å®Œæˆ"

      - name: ç”Ÿæˆæœ€ç»ˆéƒ¨ç½²æŠ¥å‘Š
        run: |
          echo "## HuanuCanvasæœ€ç»ˆéƒ¨ç½²æŠ¥å‘Š" > final-deployment-report.md
          echo "" >> final-deployment-report.md
          echo "### ğŸ“‹ éƒ¨ç½²ä¿¡æ¯" >> final-deployment-report.md
          echo "- **æ—¶é—´**: $(date)" >> final-deployment-report.md
          echo "- **ç‰ˆæœ¬**: ${{ needs.enhanced-build.outputs.version || 'N/A' }}" >> final-deployment-report.md
          echo "- **æäº¤**: ${{ github.sha }}" >> final-deployment-report.md
          echo "- **è§¦å‘**: ${{ github.event_name }}" >> final-deployment-report.md
          echo "- **éƒ¨ç½²è€…**: ${{ github.actor }}" >> final-deployment-report.md
          echo "" >> final-deployment-report.md
          
          echo "### ğŸš€ éƒ¨ç½²çŠ¶æ€" >> final-deployment-report.md
          if [ "${{ needs.deploy-production.result }}" = "success" ]; then
            echo "- **æµ‹è¯•ç¯å¢ƒ**: âœ… æˆåŠŸ" >> final-deployment-report.md
            echo "- **ç”Ÿäº§ç¯å¢ƒ**: âœ… æˆåŠŸ" >> final-deployment-report.md
            echo "- **æ€»ä½“çŠ¶æ€**: ğŸ‰ éƒ¨ç½²å®Œå…¨æˆåŠŸ" >> final-deployment-report.md
          else
            echo "- **æµ‹è¯•ç¯å¢ƒ**: âœ… æˆåŠŸ" >> final-deployment-report.md
            echo "- **ç”Ÿäº§ç¯å¢ƒ**: âŒ å¤±è´¥" >> final-deployment-report.md
            echo "- **æ€»ä½“çŠ¶æ€**: âš ï¸ éƒ¨åˆ†éƒ¨ç½²æˆåŠŸ" >> final-deployment-report.md
          fi
          echo "" >> final-deployment-report.md
          
          echo "### ğŸ”— è®¿é—®åœ°å€" >> final-deployment-report.md
          echo "- **ç”Ÿäº§ç¯å¢ƒ**: http://${{ secrets.PRODUCTION_HOST }}" >> final-deployment-report.md
          echo "- **æµ‹è¯•ç¯å¢ƒ**: http://${{ secrets.STAGING_HOST }}" >> final-deployment-report.md
          echo "- **ç›‘æ§é¢æ¿**: http://${{ secrets.PRODUCTION_HOST }}:3000" >> final-deployment-report.md
          echo "" >> final-deployment-report.md
          
          echo "### ğŸ“Š æ„å»ºä¿¡æ¯" >> final-deployment-report.md
          echo "- **å‰ç«¯é•œåƒ**: ${{ needs.enhanced-build.outputs.image-size-frontend || 'N/A' }}" >> final-deployment-report.md
          echo "- **åç«¯é•œåƒ**: ${{ needs.enhanced-build.outputs.image-size-backend || 'N/A' }}" >> final-deployment-report.md
          echo "- **æ„å»ºæ—¶é—´**: ${{ needs.enhanced-build.outputs.build-time || 'N/A' }}" >> final-deployment-report.md

      - name: ä¸Šä¼ æœ€ç»ˆæŠ¥å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: final-deployment-report-${{ github.run_number }}
          path: final-deployment-report.md
          retention-days: 90

      - name: æ›´æ–°é¡¹ç›®çŠ¶æ€
        if: success()
        run: |
          echo "âœ… é¡¹ç›®éƒ¨ç½²çŠ¶æ€æ›´æ–°å®Œæˆ"
          
          # æ›´æ–°GitHubçŠ¶æ€
          gh api -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/statuses/${{ github.sha }}" \
            -d '{
              "state": "success",
              "context": "CI/CD Pipeline",
              "description": "éƒ¨ç½²å®Œæˆ - æ‰€æœ‰æ£€æŸ¥é€šè¿‡",
              "target_url": "http://${{ secrets.PRODUCTION_HOST }}"
            }'

  # ========================================
  # ç´§æ€¥å›æ»šå¤„ç†
  # ========================================
  emergency-rollback:
    name: ç´§æ€¥å›æ»šå¤„ç†
    runs-on: ubuntu-latest
    needs: [deploy-production]
    if: failure() && github.event.inputs.force_deploy != 'true'
    
    steps:
      - name: ç´§æ€¥å›æ»š
        if: failure()
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          script: |
            echo "ğŸš¨ å¯åŠ¨ç´§æ€¥å›æ»š..."
            cd /opt/huanu-canvas
            ./scripts/auto-rollback.sh
            echo "âœ… ç´§æ€¥å›æ»šå®Œæˆ"

      - name: å›æ»šéªŒè¯
        if: failure()
        run: |
          echo "ğŸ” éªŒè¯å›æ»šç»“æœ..."
          sleep 30
          
          if curl -f "http://${{ secrets.PRODUCTION_HOST }}/health"; then
            echo "âœ… å›æ»šæˆåŠŸï¼ŒæœåŠ¡æ¢å¤æ­£å¸¸"
          else
            echo "âŒ å›æ»šå¤±è´¥ï¼Œéœ€è¦äººå·¥ä»‹å…¥"
            exit 1
          fi

      - name: å‘é€å›æ»šé€šçŸ¥
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: '#emergency'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
          message: |
            ğŸš¨ HuanuCanvasç´§æ€¥å›æ»š
            - åŸéƒ¨ç½²ç‰ˆæœ¬: ${{ needs.enhanced-build.outputs.version }}
            - å›æ»šçŠ¶æ€: æˆåŠŸ
            - å½±å“æ—¶é—´: $(date)
            - éœ€è¦å…³æ³¨: æ£€æŸ¥å¤±è´¥åŸå› 

# ========================================
# é€šçŸ¥å’ŒæŠ¥å‘Šå®Œæˆ
# ========================================
  notify-completion:
    name: é€šçŸ¥å’ŒæŠ¥å‘Šå®Œæˆ
    runs-on: ubuntu-latest
    needs: [deployment-cleanup]
    if: always()
    
    steps:
      - name: å®Œæˆé€šçŸ¥
        run: |
          echo "ğŸ‰ HuanuCanvas CI/CDæµæ°´çº¿æ‰§è¡Œå®Œæˆ"
          echo "æ€»ä½“çŠ¶æ€: ${{ job.status }}"
          echo "æ‰§è¡Œæ—¶é—´: $(date)"
          
          if [ "${{ needs.deployment-cleanup.result }}" = "success" ]; then
            echo "âœ… æ‰€æœ‰éƒ¨ç½²ä»»åŠ¡å®Œæˆ"
          else
            echo "âš ï¸ éƒ¨åˆ†ä»»åŠ¡å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
          fi